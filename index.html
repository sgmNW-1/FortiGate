<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FortiGate Delivery Master v8</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans JP', sans-serif; }
        .tab-active { border-bottom: 3px solid #dc2626; color: #dc2626; }
        .system-tag { display: inline-flex; align-items: center; background: #fee2e2; color: #991b1b; padding: 2px 8px; border-radius: 4px; margin: 2px; font-size: 0.75rem; border: 1px solid #fecaca; }
        .sync-active { background-color: #059669 !important; border-color: #047857 !important; }
        .news-card { border-left: 4px solid #dc2626; background: white; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem; border: 1px solid #e2e8f0; border-left-width: 4px; transition: all 0.2s; }
        .news-card:hover { transform: translateX(5px); border-color: #cbd5e1; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen pb-10">

    <nav class="bg-slate-900 text-white shadow-lg sticky top-0 z-50">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-3 cursor-pointer" onclick="location.reload()">
                <div class="bg-red-600 p-2 rounded-lg"><i class="fas fa-server text-white text-xl"></i></div>
                <span class="text-xl font-bold tracking-tighter text-white">FG Delivery <span class="text-red-500">Master</span></span>
            </div>
            <div class="flex items-center space-x-4">
                <div id="sync-status" class="text-[10px] px-2 py-1 rounded bg-slate-800 text-slate-400 border border-slate-700">NAS未接続</div>
                <button onclick="syncWithNAS()" class="bg-slate-700 hover:bg-slate-600 text-white px-3 py-1.5 rounded text-sm border border-slate-600 transition-all"><i class="fas fa-link mr-1 text-yellow-400"></i>NAS同期</button>
                <button onclick="saveToNAS()" class="bg-slate-700 hover:bg-slate-600 text-white px-3 py-1.5 rounded text-sm border border-slate-600 transition-all"><i class="fas fa-save mr-1 text-blue-400"></i>保存</button>
                <button onclick="enterSettings()" class="text-slate-300 hover:text-white ml-2"><i class="fas fa-cog text-xl"></i></button>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-4 py-8">
        <div class="flex space-x-8 mb-6 border-b border-gray-200">
            <button onclick="switchTab('list')" id="tab-list" class="pb-4 font-bold transition-all tab-active">納品一覧</button>
            <button onclick="switchTab('register')" id="tab-register" class="pb-4 font-bold text-gray-500 hover:text-red-600 transition-all">新規登録</button>
            <button onclick="switchTab('news')" id="tab-news" class="pb-4 font-bold text-gray-500 hover:text-orange-600 transition-all flex items-center">
                最新情報 <span id="news-dot" class="ml-2 w-2 h-2 bg-red-500 rounded-full hidden"></span>
            </button>
            <button onclick="switchTab('settings')" id="tab-settings" class="hidden pb-4 font-bold text-gray-500 hover:text-blue-600 transition-all">管理者設定</button>
        </div>

        <div id="content-news" class="hidden">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-slate-800 flex items-center">
                            <i class="fas fa-rss text-orange-500 mr-2"></i>FortiGuard PSIRT 最新アラート
                        </h3>
                        <button onclick="fetchLatestNews()" class="text-xs text-blue-600 hover:underline">
                            <i class="fas fa-sync-alt mr-1"></i>更新
                        </button>
                    </div>
                    <div id="news-container" class="space-y-4">
                        <div class="text-center py-10 text-gray-400">
                            <i class="fas fa-spinner fa-spin mr-2"></i>最新情報を取得中...
                        </div>
                    </div>
                </div>

                <div class="space-y-6">
                    <div class="bg-slate-800 p-6 rounded-xl text-white shadow-xl">
                        <h3 class="font-bold mb-4 flex items-center"><i class="fas fa-shield-alt mr-2 text-red-400"></i>管理のポイント</h3>
                        <p class="text-sm text-slate-300 leading-relaxed mb-4">
                            脆弱性が発表されたら、まずは**「対象バージョン」**を確認してください。<br><br>
                            右上の検索窓で、対象のFWバージョンを検索すれば、影響を受ける納品先をすぐにリストアップできます。
                        </p>
                        <a href="https://www.fortiguard.com/psirt" target="_blank" class="block text-center text-xs bg-red-600 hover:bg-red-700 p-2 rounded font-bold transition-colors">公式 PSIRT サイト</a>
                    </div>
                </div>
            </div>
        </div>

        <div id="content-list" class="block">
            <div class="mb-6"><input type="text" id="search-input" onkeyup="renderTable()" class="w-full md:w-1/3 border border-gray-300 rounded-lg py-2.5 px-4 shadow-sm outline-none" placeholder="納品先やFWで検索..."></div>
            <div class="bg-white rounded-2xl shadow-sm border overflow-x-auto">
                <table class="w-full text-left min-w-[1000px]">
                    <thead class="bg-slate-50 border-b text-slate-600 text-xs font-bold uppercase tracking-wider">
                        <tr><th class="px-6 py-4">納品先 / 地域</th><th class="px-6 py-4">型番 / S/N</th><th class="px-6 py-4">管理IP</th><th class="px-6 py-4">FW情報</th><th class="px-6 py-4">PW</th><th class="px-6 py-4">システム</th><th class="px-6 py-4 text-center">操作</th></tr>
                    </thead>
                    <tbody id="inventory-tbody" class="divide-y divide-gray-100"></tbody>
                </table>
            </div>
        </div>

        <div id="content-register" class="hidden">
            <div class="max-w-4xl mx-auto bg-white p-8 rounded-2xl shadow-md border">
                <h2 id="form-title" class="text-2xl font-bold text-slate-800 mb-6 border-l-4 border-red-600 pl-4">情報の登録</h2>
                <input type="hidden" id="edit-index" value="-1">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div><label class="block text-sm font-bold text-gray-700 mb-1">納品先</label><input type="text" id="reg-customer" class="w-full border p-2 rounded"></div>
                    <div><label class="block text-sm font-bold text-gray-700 mb-1">地域</label><input type="text" id="reg-region" class="w-full border p-2 rounded"></div>
                    <div><label class="block text-sm font-bold text-gray-700 mb-1">型番</label><input list="model-options" id="reg-model" class="w-full border p-2 rounded"><datalist id="model-options"></datalist></div>
                    <div><label class="block text-sm font-bold text-gray-700 mb-1">S/N</label><input type="text" id="reg-serial" class="w-full border p-2 rounded"></div>
                    <div><label class="block text-sm font-bold text-gray-700 mb-1">IP</label><input type="text" id="reg-ip" class="w-full border p-2 rounded"></div>
                    <div><label class="block text-sm font-bold text-gray-700 mb-1">FW</label><input type="text" id="reg-fw-ver" class="w-full border p-2 rounded"></div>
                    <div><label class="block text-sm font-bold text-gray-700 mb-1">更新日</label><input type="date" id="reg-fw-date" class="w-full border p-2 rounded"></div>
                    <div><label class="block text-sm font-bold text-gray-700 mb-1">PW</label><input type="text" id="reg-pw" class="w-full border p-2 rounded"></div>
                </div>
                <div class="mt-8 flex justify-end space-x-4">
                    <button id="cancel-edit-btn" onclick="cancelEdit()" class="hidden bg-gray-100 px-6 py-2 rounded font-bold">キャンセル</button>
                    <button onclick="saveData()" class="bg-red-600 text-white px-10 py-2 rounded font-bold shadow-lg">一覧に保存</button>
                </div>
            </div>
        </div>

        <div id="content-settings" class="hidden">
            <div id="settings-area" class="max-w-4xl mx-auto bg-white p-8 rounded-2xl shadow-md border">
                <h2 class="text-2xl font-bold mb-6 border-l-4 border-blue-600 pl-4">管理者設定</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="bg-slate-50 p-4 rounded shadow-inner">
                        <h3 class="font-bold mb-2">システム名マスタ</h3>
                        <div id="settings-sys-list" class="space-y-1"></div>
                    </div>
                    <div class="bg-slate-50 p-4 rounded shadow-inner">
                        <h3 class="font-bold mb-2">型番マスタ</h3>
                        <div id="settings-model-list" class="space-y-1"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const ADMIN_PW = "komayuu28";
        const VIEW_PW = "sigma-sol2012";
        const RSS_URL = "https://www.fortiguard.com/rss/ir.xml";
        // RSSをJSONに変換するプロキシ
        const RSS_BRIDGE = `https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(RSS_URL)}`;

        let inventoryData = [];
        let masterSystems = ["情報システム部", "営業部", "経理・総務", "基幹システム", "監視カメラ"];
        let masterModels = ["FG-40F", "FG-60F", "FG-80F", "FG-100F", "FG-200F"];
        let fileHandle = null;

        // --- 外部サイト連携 (自動ニュース取得) ---
        async function fetchLatestNews() {
            const container = document.getElementById('news-container');
            try {
                const response = await fetch(RSS_BRIDGE);
                const data = await response.json();
                
                if (data.status !== 'ok') throw new Error();

                container.innerHTML = data.items.map(item => `
                    <div class="news-card">
                        <div class="flex justify-between items-start mb-1">
                            <span class="text-[10px] text-blue-600 font-bold uppercase tracking-wider">PSIRT Alert</span>
                            <span class="text-[10px] text-gray-400">${item.pubDate.split(' ')[0]}</span>
                        </div>
                        <h4 class="font-bold text-slate-800 text-sm mb-2">${item.title}</h4>
                        <p class="text-[11px] text-gray-600 mb-3 line-clamp-2">${item.description.replace(/<[^>]*>?/gm, '')}</p>
                        <a href="${item.link}" target="_blank" class="text-[10px] text-red-600 font-bold hover:underline">
                            <i class="fas fa-external-link-alt mr-1"></i>詳細を確認する
                        </a>
                    </div>
                `).join('');
                document.getElementById('news-dot').classList.remove('hidden');
            } catch (err) {
                container.innerHTML = `<div class="text-sm text-red-500 p-4 bg-red-50 rounded">最新情報の取得に失敗しました。公式ポータルを確認してください。</div>`;
            }
        }

        // --- NAS同期・保存 ---
        async function syncWithNAS() {
            try {
                [fileHandle] = await window.showOpenFilePicker();
                const text = await (await fileHandle.getFile()).text();
                const p = JSON.parse(text);
                inventoryData = p.inventoryData; masterSystems = p.masterSystems; masterModels = p.masterModels;
                document.getElementById('sync-status').innerHTML = "NAS同期中";
                document.getElementById('sync-status').classList.add('bg-green-800', 'text-white');
                renderTable();
            } catch (e) {}
        }

        async function saveToNAS() {
            const data = JSON.stringify({ inventoryData, masterSystems, masterModels }, null, 2);
            if (fileHandle) {
                const w = await fileHandle.createWritable();
                await w.write(data); await w.close();
                alert("NASへ直接保存しました。");
            } else {
                const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([data])); a.download = "FG_Data.json"; a.click();
            }
        }

        // --- タブ切り替え ---
        function switchTab(t) {
            ['list', 'register', 'news', 'settings'].forEach(k => {
                document.getElementById(`content-${k}`).classList.add('hidden');
                document.getElementById(`tab-${k}`).classList.remove('tab-active');
            });
            document.getElementById(`content-${t}`).classList.remove('hidden');
            document.getElementById(`tab-${t}`).classList.add('tab-active');
            if(t === 'news') fetchLatestNews();
            if(t === 'list') renderTable();
        }

        // --- 一覧描画 ---
        function renderTable() {
            const term = document.getElementById('search-input').value.toLowerCase();
            const tbody = document.getElementById('inventory-tbody');
            const filtered = inventoryData.map((item, index) => ({item, index})).filter(o => 
                o.item.customer.toLowerCase().includes(term) || o.item.fw_version.toLowerCase().includes(term)
            );
            tbody.innerHTML = filtered.map(o => `
                <tr class="hover:bg-slate-50 transition-colors">
                    <td class="px-6 py-4"><div class="font-bold text-slate-800 text-sm">${o.item.customer}</div><div class="text-[10px] text-slate-400">${o.item.region}</div></td>
                    <td class="px-6 py-4"><div class="font-mono text-xs font-bold text-blue-700">${o.item.model}</div><div class="text-[10px] text-gray-500">S/N: ${o.item.serial}</div></td>
                    <td class="px-6 py-4 text-xs font-mono">${o.item.ip}</td>
                    <td class="px-6 py-4"><div class="text-xs font-bold text-green-600">${o.item.fw_version}</div></td>
                    <td class="px-6 py-4"><button onclick="showPw(${o.index})" class="text-[10px] border px-2 py-1 rounded">表示</button></td>
                    <td class="px-6 py-4"><div class="flex flex-wrap">${(o.item.systems || []).map(s => `<span class="system-tag">${s}</span>`).join('')}</div></td>
                    <td class="px-6 py-4 text-center">
                        <button onclick="editData(${o.index})" class="text-blue-600 mr-2"><i class="fas fa-edit"></i></button>
                        <button onclick="delData(${o.index})" class="text-red-600"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>`).join('');
        }

        // (その他の補助機能：editData, delData, saveDataなどはv7を継承)
        function showPw(i) { if(prompt("閲覧PW") === VIEW_PW) alert("PW: " + inventoryData[i].pw); }
        function enterSettings() { if(prompt("管理者PW") === ADMIN_PW) { document.getElementById('tab-settings').classList.remove('hidden'); switchTab('settings'); } }
        function saveData() {
            const i = parseInt(document.getElementById('edit-index').value);
            const item = {
                customer: document.getElementById('reg-customer').value,
                region: document.getElementById('reg-region').value,
                model: document.getElementById('reg-model').value,
                serial: document.getElementById('reg-serial').value,
                ip: document.getElementById('reg-ip').value,
                fw_version: document.getElementById('reg-fw-ver').value,
                fw_updated_at: document.getElementById('reg-fw-date').value,
                pw: document.getElementById('reg-pw').value,
                systems: []
            };
            if(i === -1) inventoryData.push(item); else inventoryData[i] = item;
            localStorage.setItem("FG_LOCAL", JSON.stringify(inventoryData));
            switchTab('list');
        }
        function editData(idx) {
            const item = inventoryData[idx];
            document.getElementById('edit-index').value = idx;
            document.getElementById('reg-customer').value = item.customer;
            document.getElementById('reg-fw-ver').value = item.fw_version;
            document.getElementById('cancel-edit-btn').classList.remove('hidden');
            switchTab('register');
        }
        function delData(idx) { if(confirm("削除？")) { inventoryData.splice(idx,1); renderTable(); } }
        function cancelEdit() { document.getElementById('edit-index').value = "-1"; switchTab('list'); }

        // 初期化
        const local = localStorage.getItem("FG_LOCAL");
        if(local) inventoryData = JSON.parse(local);
        renderTable();
    </script>
</body>
</html>