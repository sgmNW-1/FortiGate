<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FortiGate 納品管理マスター v17 Dashboard & Log Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans JP', sans-serif; background-color: #f1f5f9; color: #1e293b; }
        .tab-active { border-bottom: 3px solid #dc2626; color: #dc2626; background-color: #fff; }
        .system-tag { display: inline-flex; align-items: center; background: #fee2e2; color: #991b1b; padding: 2px 8px; border-radius: 4px; margin: 2px; font-size: 0.75rem; border: 1px solid #fecaca; }
        .vulnerable-badge { background-color: #fef2f2; border: 1px solid #fee2e2; color: #b91c1c; }
        .auto-vuln-badge { background-color: #fff7ed; border: 1px solid #ffedd5; color: #c2410c; }
        tr:hover .action-btns { opacity: 1; }
        .action-btns { opacity: 0.2; transition: opacity 0.2s; }
        .sync-indicator { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .online { background-color: #10b981; box-shadow: 0 0 8px #10b981; animation: pulse 2s infinite; }
        .alert-row { background-color: #fff1f2 !important; border-left: 4px solid #ef4444; }
        .auto-alert-row { background-color: #fff7ed !important; border-left: 4px solid #f97316; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        .scanning-pulse { animation: pulse 1.5s infinite; color: #3b82f6; }
        
        /* ログイン背景 */
        .login-bg {
            background: linear-gradient(-45deg, #0f172a, #1e293b, #334155, #0f172a);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
        }
        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* モーダルアニメーション */
        .modal-enter { animation: modalFadeIn 0.3s ease-out; }
        @keyframes modalFadeIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }

        /* スクロールバーカスタム */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="min-h-screen">

    <div id="login-screen" class="fixed inset-0 login-bg flex items-center justify-center z-[200]">
        <div class="bg-white p-10 rounded-3xl shadow-2xl w-full max-w-md border-t-8 border-red-600 transform transition-all">
            <div class="text-center mb-8">
                <div class="bg-red-50 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4 shadow-inner">
                    <i class="fas fa-users-cog text-4xl text-red-600"></i>
                </div>
                <h1 class="text-2xl font-bold text-slate-800 tracking-tighter">FG 納品管理マスター</h1>
                <p class="text-xs text-slate-500 mt-2">v17 Dashboard & Log Edition</p>
            </div>

            <div class="space-y-5">
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-1">ユーザー名</label>
                    <div class="relative">
                        <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-slate-400"><i class="fas fa-user"></i></span>
                        <input type="text" id="login-user" class="w-full border border-slate-300 rounded-xl py-3 pl-10 pr-4 outline-none focus:ring-2 focus:ring-red-500 bg-slate-50" placeholder="Username">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-1">パスワード</label>
                    <div class="relative">
                        <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-slate-400"><i class="fas fa-lock"></i></span>
                        <input type="password" id="login-pass" class="w-full border border-slate-300 rounded-xl py-3 pl-10 pr-4 outline-none focus:ring-2 focus:ring-red-500 bg-slate-50" placeholder="Password">
                    </div>
                </div>
                <button onclick="attemptLogin()" class="w-full bg-slate-900 text-white font-bold py-4 rounded-xl shadow-lg hover:bg-slate-800 transition-colors mt-4 flex justify-center items-center">
                    ログイン <i class="fas fa-sign-in-alt ml-2"></i>
                </button>
                <div id="login-status-msg" class="text-center text-xs text-slate-500 mt-2"><i class="fas fa-circle-notch fa-spin mr-1"></i>データベース接続中...</div>
                <div id="login-error" class="hidden text-center text-xs text-red-600 font-bold bg-red-50 p-2 rounded-lg border border-red-200 mt-4">ユーザー名またはパスワードが間違っています。</div>
            </div>
        </div>
    </div>

    <div id="main-app" class="hidden pb-10">
        <nav class="bg-slate-900 text-white shadow-xl sticky top-0 z-50">
            <div class="container mx-auto px-6 py-4 flex justify-between items-center">
                <div class="flex items-center space-x-3 cursor-pointer" onclick="location.reload()">
                    <div class="bg-red-600 p-2 rounded-lg"><i class="fas fa-shield-virus text-white text-xl"></i></div>
                    <div>
                        <span class="text-xl font-bold tracking-tighter">FG 納品管理 <span class="text-red-500">Master v17</span></span>
                        <p class="text-[10px] text-slate-400 leading-none mt-1"><span class="sync-indicator online"></span>クラウド同期中</p>
                    </div>
                </div>
                <div class="flex items-center space-x-6">
                    <span class="text-xs text-slate-400"><i class="fas fa-user-circle mr-1 text-green-400"></i><span id="display-username"></span></span>
                    <button onclick="enterSettings()" class="text-slate-400 hover:text-white transition-colors"><i class="fas fa-cog text-xl"></i></button>
                </div>
            </div>
        </nav>

        <div class="container mx-auto px-4 py-8">
            
            <div id="dashboard-area" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                <div class="bg-white p-5 rounded-2xl border shadow-sm border-l-4 border-l-blue-500">
                    <div class="text-slate-500 text-xs font-bold uppercase mb-1">登録デバイス合計</div>
                    <div class="flex items-end justify-between">
                        <div class="text-3xl font-black text-slate-800" id="stat-total">0</div>
                        <div class="bg-blue-50 text-blue-600 p-2 rounded-lg"><i class="fas fa-server"></i></div>
                    </div>
                </div>
                <div class="bg-white p-5 rounded-2xl border shadow-sm border-l-4 border-l-red-500 cursor-pointer hover:bg-red-50 transition-colors" onclick="setSearchFilter('vuln')">
                    <div class="text-slate-500 text-xs font-bold uppercase mb-1">脆弱性検知</div>
                    <div class="flex items-end justify-between">
                        <div class="text-3xl font-black text-red-600" id="stat-vuln">0</div>
                        <div class="bg-red-50 text-red-600 p-2 rounded-lg"><i class="fas fa-biohazard"></i></div>
                    </div>
                </div>
                <div class="bg-white p-5 rounded-2xl border shadow-sm border-l-4 border-l-orange-500 cursor-pointer hover:bg-orange-50 transition-colors" onclick="setSearchFilter('update')">
                    <div class="text-slate-500 text-xs font-bold uppercase mb-1">要アップデート</div>
                    <div class="flex items-end justify-between">
                        <div class="text-3xl font-black text-orange-600" id="stat-pending">0</div>
                        <div class="bg-orange-50 text-orange-600 p-2 rounded-lg"><i class="fas fa-arrow-alt-circle-up"></i></div>
                    </div>
                </div>
                <div class="bg-white p-5 rounded-2xl border shadow-sm border-l-4 border-l-green-500">
                    <div class="text-slate-500 text-xs font-bold uppercase mb-1">自動FW有効率</div>
                    <div class="flex items-end justify-between">
                        <div class="text-3xl font-black text-green-600" id="stat-auto-rate">0%</div>
                        <div class="bg-green-50 text-green-600 p-2 rounded-lg"><i class="fas fa-robot"></i></div>
                    </div>
                </div>
            </div>

            <div class="flex space-x-2 mb-8 bg-slate-200 p-1 rounded-xl w-fit">
                <button onclick="switchTab('list')" id="tab-list" class="px-6 py-2.5 rounded-lg font-bold transition-all tab-active"><i class="fas fa-list mr-2"></i>納品一覧</button>
                <button onclick="switchTab('register')" id="tab-register" class="px-6 py-2.5 rounded-lg font-bold text-gray-600 hover:bg-white transition-all"><i class="fas fa-plus-circle mr-2"></i>新規登録</button>
                <button onclick="switchTab('news')" id="tab-news" class="px-6 py-2.5 rounded-lg font-bold text-gray-600 hover:bg-white transition-all"><i class="fas fa-satellite-dish mr-2"></i>インテリジェンス</button>
                <button onclick="switchTab('settings')" id="tab-settings" class="hidden px-6 py-2.5 rounded-lg font-bold text-gray-600 hover:bg-white transition-all"><i class="fas fa-tools mr-2"></i>管理者設定</button>
            </div>

            <div id="content-list" class="block">
                <div class="mb-6 flex flex-wrap gap-4 items-center">
                    <div class="relative flex-1 min-w-[300px]">
                        <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-slate-400"><i class="fas fa-search"></i></span>
                        <input type="text" id="search-input" onkeyup="renderTable()" class="w-full border border-slate-300 rounded-xl py-3 pl-10 pr-4 shadow-sm outline-none focus:ring-2 focus:ring-red-500" placeholder="納品先・シリアル・FWバージョンで検索...">
                    </div>
                    <button onclick="clearSearchFilter()" id="clear-filter-btn" class="hidden text-xs bg-slate-200 px-4 py-3 rounded-xl font-bold hover:bg-slate-300 transition-all text-slate-600">フィルタ解除 <i class="fas fa-times"></i></button>
                </div>
                <div class="bg-white rounded-2xl shadow-sm border overflow-hidden overflow-x-auto">
                    <table class="w-full text-left min-w-[1200px]">
                        <thead class="bg-slate-50 border-b text-[11px] font-bold text-slate-500 uppercase">
                            <tr>
                                <th class="px-6 py-4">納品先 / 地域</th>
                                <th class="px-6 py-4">型番 / シリアル</th>
                                <th class="px-6 py-4">管理IP</th>
                                <th class="px-6 py-4">FW Ver / 最新情報</th>
                                <th class="px-6 py-4">自動FW</th>
                                <th class="px-6 py-4">PW</th>
                                <th class="px-6 py-4">関連システム</th>
                                <th class="px-6 py-4 text-center">操作</th>
                            </tr>
                        </thead>
                        <tbody id="inventory-tbody" class="divide-y divide-slate-100 text-sm"></tbody>
                    </table>
                </div>
            </div>

            <div id="content-register" class="hidden">
                <div class="max-w-4xl mx-auto bg-white p-8 rounded-3xl shadow-xl border">
                    <h2 id="form-title" class="text-2xl font-bold mb-8 border-l-4 border-red-600 pl-4 text-slate-800">機器情報の登録</h2>
                    <input type="hidden" id="edit-id" value="">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div><label class="text-sm font-bold text-slate-700">納品先名 <span class="text-red-500">*</span></label><input type="text" id="reg-customer" class="w-full border rounded-xl p-3 focus:ring-2 focus:ring-red-500 outline-none mt-1" placeholder="例: 株式会社サンプル"></div>
                        <div>
                            <label class="text-sm font-bold text-slate-700">地域</label>
                            <input list="region-options" id="reg-region" class="w-full border rounded-xl p-3 mt-1 outline-none focus:ring-2 focus:ring-red-500" placeholder="選択するか入力">
                            <datalist id="region-options"></datalist>
                        </div>
                        <div>
                            <label class="text-sm font-bold text-slate-700">型番</label>
                            <input list="model-options" id="reg-model" class="w-full border rounded-xl p-3 mt-1 outline-none focus:ring-2 focus:ring-red-500" placeholder="選択するか入力">
                            <datalist id="model-options"></datalist>
                        </div>
                        <div><label class="text-sm font-bold text-slate-700">シリアルナンバー</label><input type="text" id="reg-serial" class="w-full border rounded-xl p-3 mt-1 outline-none focus:ring-2 focus:ring-red-500" placeholder="例: FGT60FTK20001234"></div>
                        <div><label class="text-sm font-bold text-slate-700">管理IPアドレス</label><input type="text" id="reg-ip" class="w-full border rounded-xl p-3 mt-1 outline-none focus:ring-2 focus:ring-red-500" placeholder="例: 192.168.1.99"></div>
                        <div><label class="text-sm font-bold text-slate-700">FWバージョン</label><input type="text" id="reg-fw-ver" class="w-full border rounded-xl p-3 mt-1 outline-none focus:ring-2 focus:ring-red-500" placeholder="例: 7.2.4"></div>
                        <div><label class="text-sm font-bold text-slate-700">FW最終更新日</label><input type="date" id="reg-fw-date" class="w-full border rounded-xl p-3 mt-1 outline-none focus:ring-2 focus:ring-red-500"></div>
                        <div>
                            <label class="text-sm font-bold text-slate-700">自動ファームウェア設定</label>
                            <select id="reg-autofw" class="w-full border rounded-xl p-3 mt-1 outline-none focus:ring-2 focus:ring-red-500 bg-white">
                                <option value="未設定">未設定 / 不明</option>
                                <option value="OFF">OFF (手動更新)</option>
                                <option value="ON">ON (自動更新)</option>
                            </select>
                        </div>
                        <div><label class="text-sm font-bold text-slate-700">機器ログインPW</label><input type="text" id="reg-pw" class="w-full border rounded-xl p-3 mt-1 outline-none focus:ring-2 focus:ring-red-500" placeholder="管理者パスワード"></div>
                        <div class="md:col-span-2">
                            <label class="text-sm font-bold text-slate-700">関連システムタグ</label>
                            <div class="flex gap-2 mt-2">
                                <select id="reg-sys-select" class="flex-1 border rounded-xl p-3 outline-none focus:ring-2 focus:ring-red-500 bg-white"></select>
                                <button onclick="addSystemTag()" class="bg-slate-800 text-white px-8 rounded-xl font-bold hover:bg-slate-700 transition-colors">タグ追加</button>
                            </div>
                            <div id="selected-systems" class="flex flex-wrap p-4 bg-slate-50 rounded-2xl border border-dashed mt-3 min-h-[70px] items-center text-sm text-slate-400">タグ未選択</div>
                        </div>
                    </div>
                    <div class="mt-10 flex justify-end space-x-4">
                        <button id="cancel-edit-btn" onclick="cancelEdit()" class="hidden bg-slate-100 px-8 py-3 rounded-xl font-bold hover:bg-slate-200 transition-colors">キャンセル</button>
                        <button onclick="saveData()" class="bg-red-600 text-white px-12 py-3 rounded-xl font-bold shadow-lg hover:bg-red-700 transition-colors flex items-center"><i class="fas fa-cloud-upload-alt mr-2"></i>クラウドに保存</button>
                    </div>
                </div>
            </div>

            <div id="content-news" class="hidden">
                <div id="deep-scan-status" class="mb-6 bg-blue-50 text-blue-700 p-4 rounded-2xl border border-blue-200 text-sm font-bold hidden flex items-center shadow-sm">
                    <i class="fas fa-satellite-dish scanning-pulse mr-3 text-xl"></i>
                    <span>ディープスキャン実行中：最新脆弱性情報を解析しています...</span>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-2">
                        <h3 class="font-bold text-lg mb-4 text-slate-700 flex items-center"><i class="fas fa-rss text-orange-500 mr-2"></i>FortiGuard 最新ニュース</h3>
                        <div id="news-container" class="space-y-4"></div>
                    </div>
                    <div class="space-y-6">
                        <div class="bg-white p-6 rounded-2xl border-2 border-blue-200 shadow-sm">
                            <h3 class="text-blue-700 font-bold mb-3 border-b border-blue-200 pb-2 flex items-center"><i class="fas fa-level-up-alt mr-2"></i>OS系統別最新FW</h3>
                            <div id="latest-fw-display" class="grid grid-cols-1 gap-2"></div>
                        </div>
                        <div class="bg-white p-6 rounded-2xl border-2 border-red-200 shadow-sm">
                            <h3 class="text-red-700 font-bold mb-3 border-b border-red-200 pb-2 flex items-center"><i class="fas fa-biohazard mr-2"></i>要注意バージョン</h3>
                            <div id="vuln-list-display" class="space-y-2"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="content-settings" class="hidden">
                <div class="max-w-6xl mx-auto bg-white p-8 rounded-3xl border shadow-xl">
                    <h2 class="text-2xl font-bold mb-8 border-l-4 border-slate-800 pl-4">システム設定マスター</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div class="bg-slate-50 p-4 rounded-xl border">
                            <h3 class="font-bold mb-4 text-xs uppercase text-slate-500">地域マスタ</h3>
                            <div class="flex gap-2 mb-4"><input type="text" id="new-master-region" class="flex-1 border rounded-lg p-2 text-xs outline-none" placeholder="追加"><button onclick="addMaster('region')" class="bg-slate-800 text-white px-3 py-1 rounded-lg text-xs font-bold">追加</button></div>
                            <div id="settings-region-list" class="space-y-1 max-h-32 overflow-y-auto"></div>
                        </div>
                        <div class="bg-slate-50 p-4 rounded-xl border">
                            <h3 class="font-bold mb-4 text-xs uppercase text-slate-500">型番マスタ</h3>
                            <div class="flex gap-2 mb-4"><input type="text" id="new-master-model" class="flex-1 border rounded-lg p-2 text-xs outline-none" placeholder="追加"><button onclick="addMaster('model')" class="bg-slate-800 text-white px-3 py-1 rounded-lg text-xs font-bold">追加</button></div>
                            <div id="settings-model-list" class="space-y-1 max-h-32 overflow-y-auto"></div>
                        </div>
                        <div class="bg-slate-50 p-4 rounded-xl border">
                            <h3 class="font-bold mb-4 text-xs uppercase text-slate-500">システムマスタ</h3>
                            <div class="flex gap-2 mb-4"><input type="text" id="new-master-sys" class="flex-1 border rounded-lg p-2 text-xs outline-none" placeholder="追加"><button onclick="addMaster('system')" class="bg-slate-800 text-white px-3 py-1 rounded-lg text-xs font-bold">追加</button></div>
                            <div id="settings-sys-list" class="space-y-1 max-h-32 overflow-y-auto"></div>
                        </div>
                        <div class="bg-red-50 p-4 rounded-xl border border-red-100">
                            <h3 class="font-bold mb-4 text-xs uppercase text-red-500">要注意FW(手動)</h3>
                            <div class="flex gap-2 mb-4"><input type="text" id="new-master-vuln" class="flex-1 border rounded-lg p-2 text-xs outline-none" placeholder="例: 7.2.3"><button onclick="addMaster('vuln')" class="bg-red-600 text-white px-3 py-1 rounded-lg text-xs font-bold">追加</button></div>
                            <div id="settings-vuln-list" class="space-y-1 max-h-32 overflow-y-auto"></div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 border-t pt-8">
                        <div class="bg-blue-50 p-6 rounded-2xl border border-blue-100">
                            <h3 class="font-bold mb-4 text-blue-800 text-sm">最新FWマスタ（手動上書き用）</h3>
                            <div class="flex gap-2 mb-4">
                                <input type="text" id="new-master-latest-branch" class="w-1/3 border rounded-lg p-2 text-xs outline-none bg-white" placeholder="系統(7.2)">
                                <input type="text" id="new-master-latest-ver" class="flex-1 border rounded-lg p-2 text-xs outline-none bg-white" placeholder="最新版(7.2.14)">
                                <button onclick="addLatestFwMaster()" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-xs font-bold">登録</button>
                            </div>
                            <div id="settings-latest-fw-list" class="grid grid-cols-1 sm:grid-cols-2 gap-2 max-h-40 overflow-y-auto"></div>
                        </div>
                        <div class="bg-indigo-50 p-6 rounded-2xl border border-indigo-100 shadow-inner">
                            <h3 class="font-bold mb-4 text-indigo-800 text-sm">ログインユーザー管理</h3>
                            <div class="flex gap-2 mb-4">
                                <input type="text" id="new-master-user" class="w-1/3 border rounded-lg p-2 text-xs outline-none bg-white" placeholder="ID">
                                <input type="text" id="new-master-pass" class="flex-1 border rounded-lg p-2 text-xs outline-none bg-white" placeholder="PW">
                                <button onclick="addMasterUser()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-xs font-bold">追加</button>
                            </div>
                            <div id="settings-user-list" class="grid grid-cols-1 sm:grid-cols-2 gap-2 max-h-40 overflow-y-auto"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="log-modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden z-[150] flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-2xl rounded-3xl shadow-2xl overflow-hidden modal-enter">
            <div class="bg-slate-900 p-6 text-white flex justify-between items-center">
                <div>
                    <h3 id="log-modal-title" class="text-xl font-bold">作業履歴管理</h3>
                    <p id="log-modal-subtitle" class="text-xs text-slate-400 mt-1"></p>
                </div>
                <button onclick="closeLogModal()" class="text-slate-400 hover:text-white transition-colors text-2xl">&times;</button>
            </div>
            <div class="p-6">
                <div class="bg-slate-50 p-4 rounded-2xl mb-6 border border-slate-200">
                    <h4 class="text-xs font-bold text-slate-500 uppercase mb-3">新規履歴の追加</h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                        <select id="log-input-action" class="border rounded-xl p-2.5 text-sm bg-white outline-none focus:ring-2 focus:ring-red-500">
                            <option value="FWアップデート">FWアップデート</option>
                            <option value="設定変更">設定変更</option>
                            <option value="ポリシー追加">ポリシー追加</option>
                            <option value="ライセンス更新">ライセンス更新</option>
                            <option value="障害対応">障害対応</option>
                            <option value="その他">その他</option>
                        </select>
                        <input type="text" id="log-input-note" class="md:col-span-2 border rounded-xl p-2.5 text-sm bg-white outline-none focus:ring-2 focus:ring-red-500" placeholder="作業内容のメモ（例：v7.2.4へ更新）">
                        <button onclick="addLogEntry()" class="md:col-span-3 bg-slate-800 text-white font-bold py-2.5 rounded-xl hover:bg-slate-700 transition-colors">履歴を保存</button>
                    </div>
                </div>
                <div class="max-h-[400px] overflow-y-auto pr-2">
                    <div id="log-timeline-container" class="relative border-l-2 border-slate-200 ml-4 space-y-6 pb-4">
                        </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, addDoc, updateDoc, deleteDoc, doc, setDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA1natPUopWd-2SlfOAzJULYiSlJudm2Rs",
            authDomain: "fg-delivery-master.firebaseapp.com",
            projectId: "fg-delivery-master",
            storageBucket: "fg-delivery-master.firebasestorage.app",
            messagingSenderId: "752211748822",
            appId: "1:752211748822:web:754e385096f54e7ac2e677",
            measurementId: "G-Y3ZLVNTHFD"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const inventoryCol = collection(db, "inventory");
        const masterDoc = doc(db, "config", "masters");

        // グローバルステート
        window.inventoryData = [];
        window.masterRegions = ["北海道", "東北", "関東", "中部", "近畿", "中国", "四国", "九州", "沖縄"];
        window.masterSystems = ["情報システム部", "営業部", "経理・総務", "基幹システム"];
        window.masterModels = ["FG-40F", "FG-60F", "FG-80F", "FG-100F"];
        window.masterVuln = ["7.2.0", "7.0.5"];
        window.masterLatestFw = {};
        window.masterUsers = [{ user: "admin", pass: "forti2026" }];
        window.autoDetectedVuln = [];
        window.autoLatestFw = {};
        window.selectedSystems = [];
        window.currentUser = "";
        window.activeLogDeviceId = null;
        window.searchFilterType = null; // 'vuln' or 'update'

        const ADMIN_PW = "komayuu28";
        const VIEW_PW = "sigma-sol2012";
        let isDbConnected = false;

        // ==========================================
        // 初期データ取得 & ログイン
        // ==========================================
        onSnapshot(masterDoc, (docSnap) => {
            if (docSnap.exists()) {
                const data = docSnap.data();
                window.masterRegions = data.regions || window.masterRegions;
                window.masterSystems = data.systems || window.masterSystems;
                window.masterModels = data.models || window.masterModels;
                window.masterVuln = data.vuln || window.masterVuln;
                window.masterLatestFw = data.latestFw || window.masterLatestFw;
                window.masterUsers = data.users || window.masterUsers;
                isDbConnected = true;
                const statusMsg = document.getElementById('login-status-msg');
                if(statusMsg) statusMsg.innerHTML = '<span class="text-green-600"><i class="fas fa-check-circle mr-1"></i>DB Ready</span>';
                
                if(!document.getElementById('main-app').classList.contains('hidden')) {
                    refreshAllUI();
                }
            } else {
                saveAllMastersToFirebase();
            }
        });

        window.attemptLogin = () => {
            if(!isDbConnected) return alert("同期中...");
            const inputUser = document.getElementById('login-user').value.trim();
            const inputPass = document.getElementById('login-pass').value.trim();
            const valid = window.masterUsers.find(u => u.user === inputUser && u.pass === inputPass);
            if(valid) {
                window.currentUser = inputUser;
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('main-app').classList.remove('hidden');
                document.getElementById('display-username').innerText = inputUser;
                initApp();
            } else {
                document.getElementById('login-error').classList.remove('hidden');
            }
        };

        function initApp() {
            onSnapshot(inventoryCol, (snapshot) => {
                window.inventoryData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                refreshAllUI();
            });
            fetchNews();
        }

        function refreshAllUI() {
            updateDynamicLists();
            renderTable();
            renderVulnDisplay();
            renderLatestFwMaster();
            renderLatestFwDisplay();
            renderMasterLists();
            renderMasterUserList();
            calculateDashboard(); // ダッシュボード更新
        }

        // ==========================================
        // 3. ダッシュボード計算ロジック
        // ==========================================
        function calculateDashboard() {
            const total = window.inventoryData.length;
            let vulnCnt = 0;
            let pendingCnt = 0;
            let autoOnCnt = 0;

            window.inventoryData.forEach(item => {
                // 脆弱性カウント
                const isVuln = window.masterVuln.includes(item.fw_version) || window.autoDetectedVuln.includes(item.fw_version);
                if(isVuln) vulnCnt++;

                // アップデート待ちカウント
                const fwMatch = (item.fw_version || "").match(/^(\d+\.\d+)\.(\d+)$/);
                if(fwMatch) {
                    const branch = fwMatch[1];
                    const patch = parseInt(fwMatch[2]);
                    const latestStr = window.masterLatestFw[branch] || window.autoLatestFw[branch];
                    if(latestStr) {
                        const latestMatch = latestStr.match(/^(\d+\.\d+)\.(\d+)$/);
                        if(latestMatch && parseInt(latestMatch[2]) > patch) pendingCnt++;
                    }
                }

                // 自動FW率
                if(item.auto_fw === "ON") autoOnCnt++;
            });

            document.getElementById('stat-total').innerText = total;
            document.getElementById('stat-vuln').innerText = vulnCnt;
            document.getElementById('stat-pending').innerText = pendingCnt;
            document.getElementById('stat-auto-rate').innerText = total > 0 ? Math.round((autoOnCnt / total) * 100) + "%" : "0%";
        }

        window.setSearchFilter = (type) => {
            window.searchFilterType = type;
            document.getElementById('clear-filter-btn').classList.remove('hidden');
            renderTable();
        };

        window.clearSearchFilter = () => {
            window.searchFilterType = null;
            document.getElementById('clear-filter-btn').classList.add('hidden');
            document.getElementById('search-input').value = "";
            renderTable();
        };

        // ==========================================
        // 2. 履歴管理ロジック
        // ==========================================
        window.openLogModal = (deviceId) => {
            window.activeLogDeviceId = deviceId;
            const item = window.inventoryData.find(i => i.id === deviceId);
            document.getElementById('log-modal-title').innerText = `${item.customer} の履歴`;
            document.getElementById('log-modal-subtitle').innerText = `${item.model} (${item.serial})`;
            renderTimeline();
            document.getElementById('log-modal').classList.remove('hidden');
        };

        window.closeLogModal = () => {
            document.getElementById('log-modal').classList.add('hidden');
            window.activeLogDeviceId = null;
        };

        window.addLogEntry = async () => {
            const action = document.getElementById('log-input-action').value;
            const note = document.getElementById('log-input-note').value.trim();
            if(!note) return alert("内容を入力してください");

            const newLog = {
                date: new Date().toLocaleString('ja-JP'),
                user: window.currentUser,
                action: action,
                note: note
            };

            const deviceDoc = doc(db, "inventory", window.activeLogDeviceId);
            try {
                await updateDoc(deviceDoc, {
                    logs: arrayUnion(newLog)
                });
                document.getElementById('log-input-note').value = "";
                renderTimeline(); // 即時反映は snapshot がやってくれるが、配列追加なので手動で再描画を促す
            } catch (e) { alert("保存失敗: " + e); }
        };

        function renderTimeline() {
            const container = document.getElementById('log-timeline-container');
            const item = window.inventoryData.find(i => i.id === window.activeLogDeviceId);
            const logs = item.logs || [];

            if(logs.length === 0) {
                container.innerHTML = '<div class="pl-8 text-slate-400 text-sm">作業履歴はまだありません。</div>';
                return;
            }

            container.innerHTML = logs.slice().reverse().map(log => `
                <div class="relative pl-8">
                    <div class="absolute -left-[9px] top-1.5 w-4 h-4 rounded-full bg-slate-900 border-4 border-white shadow-sm"></div>
                    <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100 shadow-sm">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">${log.date}</span>
                            <span class="text-[10px] bg-slate-200 text-slate-600 px-2 py-0.5 rounded-full font-bold"><i class="fas fa-user mr-1"></i>${log.user}</span>
                        </div>
                        <div class="font-bold text-slate-800 text-sm mb-1">${log.action}</div>
                        <p class="text-xs text-slate-600 leading-relaxed">${log.note}</p>
                    </div>
                </div>
            `).join('');
        }

        // ==========================================
        // これまでの基本機能
        // ==========================================
        window.renderTable = () => {
            const term = document.getElementById('search-input').value.toLowerCase();
            const tbody = document.getElementById('inventory-tbody');
            
            let filtered = window.inventoryData.filter(i => 
                (i.customer || "").toLowerCase().includes(term) || 
                (i.fw_version || "").toLowerCase().includes(term) || 
                (i.model || "").toLowerCase().includes(term) ||
                (i.serial || "").toLowerCase().includes(term)
            );

            // ダッシュボードからのフィルタ適用
            if(window.searchFilterType === 'vuln') {
                filtered = filtered.filter(item => window.masterVuln.includes(item.fw_version) || window.autoDetectedVuln.includes(item.fw_version));
            } else if(window.searchFilterType === 'update') {
                filtered = filtered.filter(item => {
                    const fwMatch = (item.fw_version || "").match(/^(\d+\.\d+)\.(\d+)$/);
                    if(!fwMatch) return false;
                    const latestStr = window.masterLatestFw[fwMatch[1]] || window.autoLatestFw[fwMatch[1]];
                    if(!latestStr) return false;
                    const latestMatch = latestStr.match(/^(\d+\.\d+)\.(\d+)$/);
                    return latestMatch && parseInt(latestMatch[2]) > parseInt(fwMatch[2]);
                });
            }
            
            tbody.innerHTML = filtered.map(item => {
                const isVuln = window.masterVuln.includes(item.fw_version) || window.autoDetectedVuln.includes(item.fw_version);
                let rowClass = "hover:bg-slate-50 transition-colors";
                let fwClass = "text-green-700 font-bold";
                if (isVuln) {
                    rowClass = item.auto_fw === "ON" ? "auto-alert-row" : "alert-row";
                    fwClass = "text-red-600 font-bold bg-white px-2 py-1 rounded border";
                }
                
                let fwUpdateBadge = '';
                const fwMatch = (item.fw_version || "").match(/^(\d+\.\d+)\.(\d+)$/);
                if(fwMatch) {
                    const branch = fwMatch[1];
                    const latestStr = window.masterLatestFw[branch] || window.autoLatestFw[branch];
                    if(latestStr && parseInt(latestStr.split('.')[2]) > parseInt(fwMatch[2])) {
                        fwUpdateBadge = `<div class="text-[9px] text-blue-600 font-bold mt-1.5 bg-blue-50 px-2 py-0.5 rounded border border-blue-100"><i class="fas fa-arrow-circle-up mr-1"></i>新版 ${latestStr} あり</div>`;
                    }
                }

                return `
                <tr class="${rowClass} group">
                    <td class="px-6 py-5"><div class="font-bold text-slate-800">${item.customer}</div><div class="text-[10px] text-slate-500">${item.region || '-'}</div></td>
                    <td class="px-6 py-5"><div class="font-mono text-xs font-bold text-slate-700 bg-slate-100 px-2 py-0.5 rounded inline-block border">${item.model || '-'}</div><div class="text-[10px] text-slate-400 mt-1 font-mono">${item.serial || '-'}</div></td>
                    <td class="px-6 py-5 text-xs font-mono">${item.ip || '-'}</td>
                    <td class="px-6 py-5"><div class="text-xs ${fwClass}">${item.fw_version || '-'}</div>${fwUpdateBadge}</td>
                    <td class="px-6 py-5"><span class="text-[10px] ${item.auto_fw === 'ON' ? 'text-blue-600 font-bold' : 'text-slate-400'}">${item.auto_fw || '未設定'}</span></td>
                    <td class="px-6 py-5"><button onclick="showPw('${item.pw || ''}')" class="text-[10px] border px-2 py-1 rounded bg-white shadow-sm hover:bg-slate-50">表示</button></td>
                    <td class="px-6 py-5"><div class="flex flex-wrap">${(item.systems || []).map(s => `<span class="system-tag">${s}</span>`).join('')}</div></td>
                    <td class="px-6 py-5 text-center">
                        <div class="action-btns flex justify-center space-x-1">
                            <button onclick="openLogModal('${item.id}')" class="p-2 text-slate-500 hover:text-slate-900" title="履歴"><i class="fas fa-history"></i></button>
                            <button onclick="editData('${item.id}')" class="p-2 text-blue-500 hover:text-blue-700" title="編集"><i class="fas fa-edit"></i></button>
                            <button onclick="deleteData('${item.id}')" class="p-2 text-red-400 hover:text-red-700" title="削除"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    </td>
                </tr>`;
            }).join('');
        };

        window.saveData = async () => {
            const id = document.getElementById('edit-id').value;
            const newItem = {
                customer: document.getElementById('reg-customer').value,
                region: document.getElementById('reg-region').value,
                model: document.getElementById('reg-model').value,
                serial: document.getElementById('reg-serial').value,
                ip: document.getElementById('reg-ip').value,
                fw_version: document.getElementById('reg-fw-ver').value,
                fw_updated_at: document.getElementById('reg-fw-date').value,
                auto_fw: document.getElementById('reg-autofw').value,
                pw: document.getElementById('reg-pw').value,
                systems: [...window.selectedSystems],
                updatedAt: new Date()
            };
            if(!newItem.customer) return alert("顧客名必須");
            try {
                if(id) await updateDoc(doc(db, "inventory", id), newItem);
                else await addDoc(inventoryCol, { ...newItem, logs: [] });
                alert("クラウド同期完了");
                cancelEdit(); switchTab('list');
            } catch (e) { alert(e); }
        };

        window.deleteData = async (id) => { if(confirm("削除しますか？")) await deleteDoc(doc(db, "inventory", id)); };

        window.editData = (id) => {
            const item = window.inventoryData.find(i => i.id === id);
            document.getElementById('edit-id').value = id;
            document.getElementById('reg-customer').value = item.customer || "";
            document.getElementById('reg-region').value = item.region || "";
            document.getElementById('reg-model').value = item.model || "";
            document.getElementById('reg-serial').value = item.serial || "";
            document.getElementById('reg-ip').value = item.ip || "";
            document.getElementById('reg-fw-ver').value = item.fw_version || "";
            document.getElementById('reg-fw-date').value = item.fw_updated_at || "";
            document.getElementById('reg-autofw').value = item.auto_fw || "未設定";
            document.getElementById('reg-pw').value = item.pw || "";
            window.selectedSystems = [...(item.systems || [])];
            updateSystemTags();
            document.getElementById('form-title').innerText = "機器情報の編集";
            document.getElementById('cancel-edit-btn').classList.remove('hidden');
            switchTab('register');
        };

        window.cancelEdit = () => {
            document.getElementById('edit-id').value = "";
            ['reg-customer','reg-region','reg-model','reg-serial','reg-ip','reg-fw-ver','reg-fw-date','reg-pw'].forEach(id => document.getElementById(id).value = "");
            document.getElementById('reg-autofw').value = "未設定";
            window.selectedSystems = []; updateSystemTags();
            document.getElementById('form-title').innerText = "機器情報の登録";
            document.getElementById('cancel-edit-btn').classList.add('hidden');
        };

        // マスタ管理
        const saveAllMastersToFirebase = async () => {
            await setDoc(masterDoc, { 
                regions: window.masterRegions, systems: window.masterSystems, models: window.masterModels, 
                vuln: window.masterVuln, latestFw: window.masterLatestFw, users: window.masterUsers 
            });
        };
        window.addMaster = async (type) => {
            const val = document.getElementById(`new-master-${type}`).value.trim();
            if(!val) return;
            if(type==='region') window.masterRegions.push(val);
            else if(type==='system') window.masterSystems.push(val);
            else if(type==='model') window.masterModels.push(val);
            else if(type==='vuln') window.masterVuln.push(val);
            await saveAllMastersToFirebase();
            document.getElementById(`new-master-${type}`).value = "";
        };
        window.removeMaster = async (type, val) => {
            if(!confirm(`削除: ${val}`)) return;
            if(type==='region') window.masterRegions = window.masterRegions.filter(x => x !== val);
            else if(type==='system') window.masterSystems = window.masterSystems.filter(x => x !== val);
            else if(type==='model') window.masterModels = window.masterModels.filter(x => x !== val);
            else if(type==='vuln') window.masterVuln = window.masterVuln.filter(x => x !== val);
            await saveAllMastersToFirebase();
        };

        window.addMasterUser = async () => {
            const u = document.getElementById('new-master-user').value.trim();
            const p = document.getElementById('new-master-pass').value.trim();
            if(!u || !p) return;
            window.masterUsers.push({ user: u, pass: p });
            await saveAllMastersToFirebase();
            document.getElementById('new-master-user').value = ""; document.getElementById('new-master-pass').value = "";
        };

        window.addLatestFwMaster = async () => {
            const branch = document.getElementById('new-master-latest-branch').value.trim();
            const ver = document.getElementById('new-master-latest-ver').value.trim();
            if(!branch || !ver) return;
            window.masterLatestFw[branch] = ver;
            await saveAllMastersToFirebase();
            document.getElementById('new-master-latest-branch').value = ""; document.getElementById('new-master-latest-ver').value = "";
        };

        // 補助UI
        window.switchTab = (tab) => {
            ['list', 'register', 'news', 'settings'].forEach(t => {
                document.getElementById(`content-${t}`).classList.add('hidden');
                document.getElementById(`tab-${t}`).classList.remove('tab-active');
            });
            document.getElementById(`content-${tab}`).classList.remove('hidden');
            document.getElementById(`tab-${tab}`).classList.add('tab-active');
        };
        window.showPw = (pw) => { 
            if(!pw) return alert("未登録");
            if(prompt("閲覧PW") === VIEW_PW) alert("PW: " + pw); 
        };
        window.addSystemTag = () => {
            const v = document.getElementById('reg-sys-select').value;
            if(v && !window.selectedSystems.includes(v)) { window.selectedSystems.push(v); updateSystemTags(); }
        };
        window.updateSystemTags = () => {
            const container = document.getElementById('selected-systems');
            if(window.selectedSystems.length === 0) container.innerHTML = "タグ未選択";
            else container.innerHTML = window.selectedSystems.map(s => `<span class="system-tag bg-slate-200 text-slate-700">${s} <i class="fas fa-times-circle ml-2 cursor-pointer" onclick="removeTag('${s}')"></i></span>`).join('');
        };
        window.removeTag = (s) => { window.selectedSystems = window.selectedSystems.filter(x => x !== s); updateSystemTags(); };
        window.updateDynamicLists = () => {
            document.getElementById('region-options').innerHTML = window.masterRegions.map(r => `<option value="${r}">`).join('');
            document.getElementById('model-options').innerHTML = window.masterModels.map(m => `<option value="${m}">`).join('');
            document.getElementById('reg-sys-select').innerHTML = '<option value="">システムを選択...</option>' + window.masterSystems.map(s => `<option value="${s}">${s}</option>`).join('');
        };
        window.renderMasterLists = () => {
            const draw = (arr, type) => arr.map(item => `<div class="flex justify-between items-center bg-white p-2 border rounded-lg text-xs mb-1"><span>${item}</span><button onclick="removeMaster('${type}', '${item}')" class="text-red-400 hover:text-red-600"><i class="fas fa-trash-alt"></i></button></div>`).join('');
            document.getElementById('settings-region-list').innerHTML = draw(window.masterRegions, 'region');
            document.getElementById('settings-sys-list').innerHTML = draw(window.masterSystems, 'system');
            document.getElementById('settings-model-list').innerHTML = draw(window.masterModels, 'model');
            document.getElementById('settings-vuln-list').innerHTML = draw(window.masterVuln, 'vuln');
        };
        window.renderMasterUserList = () => {
            document.getElementById('settings-user-list').innerHTML = window.masterUsers.map(u => `<div class="bg-white p-2 border rounded-lg text-xs flex justify-between items-center"><span><b>${u.user}</b> (***)</span><button onclick="removeMasterUser('${u.user}')" class="text-red-300 hover:text-red-600"><i class="fas fa-trash-alt"></i></button></div>`).join('');
        };
        window.removeMasterUser = async (u) => { if(window.masterUsers.length > 1) { window.masterUsers = window.masterUsers.filter(x=>x.user!==u); await saveAllMastersToFirebase(); } };
        window.renderLatestFwMaster = () => {
            document.getElementById('settings-latest-fw-list').innerHTML = Object.entries(window.masterLatestFw).map(([b,v])=>`<div class="bg-white p-2 border rounded-lg text-xs flex justify-between items-center"><span>${b}.x → ${v}</span><button onclick="removeLatestFwMaster('${b}')" class="text-red-300"><i class="fas fa-trash-alt"></i></button></div>`).join('');
        };
        window.removeLatestFwMaster = async (b) => { delete window.masterLatestFw[b]; await saveAllMastersToFirebase(); };
        window.renderVulnDisplay = () => {
            document.getElementById('vuln-list-display').innerHTML = window.masterVuln.map(v => `<div class="p-3 vulnerable-badge rounded-lg flex items-center text-xs font-bold shadow-sm"><i class="fas fa-skull-crossbones mr-2"></i>v ${v}</div>`).join('');
        };
        window.renderLatestFwDisplay = () => {
            const combined = { ...window.autoLatestFw, ...window.masterLatestFw };
            document.getElementById('latest-fw-display').innerHTML = Object.keys(combined).sort().reverse().map(b => `<div class="bg-slate-50 border rounded-lg p-3 flex justify-between items-center shadow-sm"><span class="font-bold text-slate-600 text-xs">${b}.x</span><span class="font-mono text-blue-700 font-black">${combined[b]}</span></div>`).join('');
        };
        window.enterSettings = () => { if(prompt("管理者PW") === ADMIN_PW) { document.getElementById('tab-settings').classList.remove('hidden'); switchTab('settings'); } };

        async function fetchNews() {
            const container = document.getElementById('news-container');
            const statusIndicator = document.getElementById('deep-scan-status');
            container.innerHTML = '<div class="text-center py-10 text-slate-400 text-xs"><i class="fas fa-spinner fa-spin mb-2"></i> スキャン中...</div>';
            statusIndicator.classList.remove('hidden');
            try {
                const rss = "https://api.rss2json.com/v1/api.json?rss_url=" + encodeURIComponent("https://www.fortiguard.com/rss/ir.xml");
                const res = await fetch(rss);
                const data = await res.json();
                container.innerHTML = data.items.slice(0, 5).map(i => `<div class="bg-white p-4 rounded-xl border border-l-4 border-l-orange-400"><h4 class="font-bold text-xs mb-1">${i.title}</h4><a href="${i.link}" target="_blank" class="text-[10px] text-blue-500 hover:underline">詳細確認 <i class="fas fa-external-link-alt"></i></a></div>`).join('');
                
                // バージョン抽出（簡易版）
                const verRegex = /\b([567]\.\d+\.\d+)\b/g;
                let latestMap = {};
                for(let i=0; i<3; i++) {
                    const proxy = "https://api.allorigins.win/get?url=" + encodeURIComponent(data.items[i].link);
                    const pRes = await fetch(proxy); const pData = await pRes.json();
                    const matches = pData.contents ? pData.contents.match(verRegex) : null;
                    if(matches) {
                        matches.forEach(m => {
                            const p = m.split('.'); const b = `${p[0]}.${p[1]}`; const v = parseInt(p[2]);
                            if(!latestMap[b] || v > parseInt(latestMap[b].split('.')[2])) latestMap[b] = m;
                        });
                    }
                }
                window.autoLatestFw = latestMap;
                refreshAllUI();
                statusIndicator.classList.add('hidden');
            } catch (e) { statusIndicator.classList.add('hidden'); }
        }
    </script>
</body>
</html>