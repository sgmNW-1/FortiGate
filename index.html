<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FortiGate納品機器管理マスタ v34</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&display=swap');
        
        body { 
            font-family: 'Noto Sans JP', sans-serif; 
            background-color: #e2e8f0; 
            color: #0f172a; 
        }

        .card-container {
            background-color: #ffffff;
            border: 1px solid #cbd5e1;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .tab-active { 
            border-bottom: 4px solid #dc2626; 
            color: #dc2626; 
            background-color: #ffffff; 
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
        }

        /* タグのスタイル */
        .dept-tag { 
            display: inline-flex; 
            align-items: center; 
            background: #fee2e2; 
            color: #991b1b; 
            padding: 4px 10px; 
            border-radius: 6px; 
            margin: 2px; 
            font-size: 0.75rem; 
            border: 1px solid #fecaca; 
            font-weight: bold; 
        }
        .usage-tag {
            display: inline-flex; 
            align-items: center; 
            background: #e0f2fe; 
            color: #0369a1; 
            padding: 4px 10px; 
            border-radius: 6px; 
            margin: 2px; 
            font-size: 0.75rem; 
            border: 1px solid #bae6fd; 
            font-weight: bold; 
        }

        .online { background-color: #10b981; box-shadow: 0 0 10px #10b981; animation: pulse 2s infinite; }
        .offline { background-color: #ef4444; }
        .alert-row { background-color: #fff1f2 !important; border-left: 5px solid #ef4444; }
        .auto-fw-active-row { background-color: #f0fdf4 !important; border-left: 5px solid #22c55e; }
        
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        
        .login-bg { 
            background: linear-gradient(-45deg, #0f172a, #1e293b, #334155, #0f172a); 
            background-size: 400% 400%; 
            animation: gradientBG 15s ease infinite; 
        }
        @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        .sync-dot { animation: syncPulse 1.5s infinite; }
        @keyframes syncPulse { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }

        /* 入力フィールドの視認性向上 */
        input, select, textarea {
            border: 2px solid #cbd5e1 !important; 
            transition: all 0.2s;
        }
        input:focus, select:focus {
            border-color: #dc2626 !important;
            box-shadow: 0 0 0 4px rgba(220, 38, 38, 0.1) !important;
            background-color: #fff !important;
        }
        
        label {
            color: #1e293b !important; 
            font-weight: 900 !important;
            margin-bottom: 0.5rem;
            display: block;
        }
    </style>
</head>
<body class="min-h-screen">

    <div id="login-screen" class="fixed inset-0 login-bg flex items-center justify-center z-[200]">
        <div class="bg-white p-10 rounded-[3rem] shadow-2xl w-full max-w-md border border-white/20">
            <div class="text-center mb-8">
                <div class="bg-red-600 w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg rotate-3">
                    <i class="fas fa-shield-alt text-3xl text-white"></i>
                </div>
                <h1 class="text-2xl font-black text-slate-800 tracking-tight">FortiGate納品機器管理マスタ</h1>
                <div class="flex items-center justify-center space-x-2 mt-2">
                    <span class="w-2 h-2 bg-green-500 rounded-full sync-dot"></span>
                    <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">クラウド同期中...</p>
                </div>
            </div>
            <div class="space-y-4">
                <input type="text" id="login-user" placeholder="ユーザー名" class="w-full rounded-xl py-4 px-5 outline-none bg-slate-50 font-bold">
                <input type="password" id="login-pass" placeholder="パスワード" class="w-full rounded-xl py-4 px-5 outline-none bg-slate-50 font-bold">
                <button type="button" onclick="attemptLogin()" class="w-full bg-slate-900 text-white font-black py-4 rounded-xl shadow-xl hover:bg-red-600 transition-all transform hover:-translate-y-1">ログイン</button>
                <div id="login-error" class="hidden text-center text-xs text-red-600 font-bold bg-red-50 p-3 rounded-xl border border-red-100">認証に失敗しました。</div>
            </div>
        </div>
    </div>

    <div id="main-app" class="hidden pb-20">
        <nav class="bg-slate-900 text-white sticky top-0 z-50 border-b border-slate-800 shadow-xl">
            <div class="w-full px-8 py-4 flex justify-between items-center">
                <div class="flex items-center space-x-4 cursor-pointer" onclick="location.reload()">
                    <div class="bg-red-600 p-2 rounded-lg shadow-inner"><i class="fas fa-network-wired text-white text-xl"></i></div>
                    <div>
                        <span class="text-xl font-black tracking-tighter uppercase">FortiGate 納品機器管理マスタ</span>
                        <div class="flex items-center space-x-1">
                            <span class="w-1.5 h-1.5 bg-green-500 rounded-full sync-dot"></span>
                            <span class="text-[10px] text-slate-500 font-bold uppercase tracking-widest">クラウド同期中</span>
                        </div>
                    </div>
                </div>
                <div class="flex items-center space-x-6">
                    <div class="text-right">
                        <p class="text-[10px] text-slate-500 font-bold uppercase tracking-widest mb-1">Auth-User</p>
                        <span id="display-username" class="text-sm font-bold text-slate-200"></span>
                    </div>
                    <button type="button" onclick="enterSettings()" class="bg-slate-800 p-3 rounded-xl text-slate-400 hover:text-white border border-slate-700 hover:border-slate-500"><i class="fas fa-cog"></i></button>
                </div>
            </div>
        </nav>

        <div class="w-full px-8 py-8">
            <div id="dashboard-area" class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="bg-white p-6 rounded-2xl shadow-md border-2 border-slate-300"><p class="text-[10px] font-black text-slate-500 mb-2 uppercase tracking-widest">Total Devices</p><span class="text-3xl font-black text-slate-800" id="stat-total">0</span></div>
                <div class="bg-white p-6 rounded-2xl shadow-md border-2 border-slate-300 cursor-pointer hover:bg-red-50 transition-colors" onclick="setSearchFilter('vuln')"><p class="text-[10px] font-black text-red-500 mb-2 uppercase tracking-widest">Vulnerabilities</p><span class="text-3xl font-black text-red-600" id="stat-vuln">0</span></div>
                <div class="bg-white p-6 rounded-2xl shadow-md border-2 border-slate-300 cursor-pointer hover:bg-orange-50 transition-colors" onclick="setSearchFilter('update')"><p class="text-[10px] font-black text-orange-500 mb-2 uppercase tracking-widest">Pending Updates</p><span class="text-3xl font-black text-orange-600" id="stat-pending">0</span></div>
                <div class="bg-white p-6 rounded-2xl shadow-md border-2 border-slate-300"><p class="text-[10px] font-black text-green-600 mb-2 uppercase tracking-widest">Auto FW Active</p><span class="text-3xl font-black text-green-600" id="stat-auto-count">0</span></div>
            </div>

            <div class="flex space-x-2 mb-8 bg-slate-300 p-1.5 rounded-2xl w-fit shadow-inner">
                <button type="button" onclick="switchTab('list')" id="tab-list" class="px-8 py-2.5 rounded-xl font-black tab-active transition-all shadow-sm">納品機器一覧</button>
                <button type="button" onclick="switchTab('register')" id="tab-register" class="px-8 py-2.5 rounded-xl font-black text-slate-600 hover:text-slate-900 transition-all">機器登録</button>
                <button type="button" onclick="switchTab('news')" id="tab-news" class="px-8 py-2.5 rounded-xl font-black text-slate-600 hover:text-slate-900 transition-all flex items-center"><i class="fas fa-bolt mr-2 text-indigo-500"></i>解析・Auto FW</button>
                <button type="button" id="tab-settings" class="hidden px-8 py-2.5 rounded-xl font-black text-slate-600 transition-all cursor-default" style="display: none;">管理者設定</button>
            </div>

            <div id="content-list">
                <div class="mb-6 flex gap-4 items-center">
                    <div class="relative flex-1">
                        <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
                        <input type="text" id="search-input" onkeyup="renderTable()" class="w-full rounded-2xl py-4 pl-12 pr-6 outline-none font-bold shadow-md focus:ring-4 focus:ring-red-500/10 transition-all bg-white" placeholder="顧客名、SN、使用用途、地域で検索...">
                    </div>
                    <button type="button" onclick="clearSearchFilter()" id="clear-filter-btn" class="hidden bg-slate-900 text-white px-6 py-4 rounded-2xl font-black hover:bg-red-600 transition-all shadow-lg">フィルタ解除 &times;</button>
                </div>
                <div class="bg-white rounded-[2rem] shadow-2xl border-2 border-slate-300 overflow-hidden">
                    <table class="w-full text-left">
                        <thead class="bg-slate-100 text-[11px] font-black text-slate-600 border-b-2 border-slate-300 uppercase tracking-tighter">
                            <tr>
                                <th class="px-8 py-5">納品先 / 地域</th>
                                <th class="px-8 py-5">使用用途</th>
                                <th class="px-8 py-5">型番 / SN</th>
                                <th class="px-8 py-5">管理IP / PW</th>
                                <th class="px-8 py-5">FW Ver</th>
                                <th class="px-8 py-5">自動FW</th>
                                <th class="px-8 py-5">相乗り部門</th>
                                <th class="px-8 py-5 text-center">操作</th>
                            </tr>
                        </thead>
                        <tbody id="inventory-tbody" class="divide-y divide-slate-200 text-sm"></tbody>
                    </table>
                </div>
            </div>

            <div id="content-register" class="hidden">
                <div class="max-w-5xl mx-auto bg-white p-10 rounded-[3rem] shadow-2xl border-2 border-slate-300">
                    <h2 id="form-title" class="text-3xl font-black mb-10 border-l-8 border-red-600 pl-6 text-slate-800 uppercase tracking-tight">機器情報の登録</h2>
                    <input type="hidden" id="edit-id" value="">
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="space-y-2"><label>納品先名 *</label><input type="text" id="reg-customer" class="w-full rounded-2xl p-4 font-bold bg-white" placeholder="株式会社〇〇"></div>
                        <div class="space-y-2">
                            <label>地域 (マスタ反映)</label>
                            <input list="region-options" id="reg-region" class="w-full rounded-2xl p-4 font-bold bg-white">
                            <datalist id="region-options"></datalist>
                        </div>

                        <div class="md:col-span-2 space-y-4 bg-slate-50 p-6 rounded-[2rem] border-2 border-slate-200">
                            <label class="!mb-0">使用用途 (複数選択可)</label>
                            <div class="flex flex-wrap gap-3">
                                <button type="button" onclick="toggleUsage('VPN')" id="btn-usage-VPN" class="usage-btn px-6 py-2 rounded-xl border-2 border-slate-300 font-bold text-sm hover:bg-slate-200 transition-all bg-white">VPN</button>
                                <button type="button" onclick="toggleUsage('ゲストWi-Fi')" id="btn-usage-ゲストWi-Fi" class="usage-btn px-6 py-2 rounded-xl border-2 border-slate-300 font-bold text-sm hover:bg-slate-200 transition-all bg-white">ゲストWi-Fi</button>
                                <button type="button" onclick="toggleUsage('職員情報系')" id="btn-usage-職員情報系" class="usage-btn px-6 py-2 rounded-xl border-2 border-slate-300 font-bold text-sm hover:bg-slate-200 transition-all bg-white">職員情報系</button>
                                <button type="button" onclick="toggleUsage('ホワイトリスト')" id="btn-usage-ホワイトリスト" class="usage-btn px-6 py-2 rounded-xl border-2 border-slate-300 font-bold text-sm hover:bg-slate-200 transition-all bg-white">ホワイトリスト</button>
                            </div>
                        </div>

                        <div class="space-y-2">
                            <label>型番 (マスタ反映)</label>
                            <input list="model-options" id="reg-model" class="w-full rounded-2xl p-4 font-bold bg-white">
                            <datalist id="model-options"></datalist>
                        </div>
                        <div class="space-y-2"><label>シリアルナンバー</label><input type="text" id="reg-serial" class="w-full rounded-2xl p-4 font-mono font-bold bg-white"></div>
                        <div class="space-y-2"><label>管理IP</label><input type="text" id="reg-ip" class="w-full rounded-2xl p-4 font-mono font-bold bg-white" placeholder="192.168.1.1"></div>
                        <div class="space-y-2"><label>管理パスワード</label><input type="text" id="reg-password" class="w-full rounded-2xl p-4 font-mono font-bold bg-white"></div>
                        
                        <div class="space-y-2"><label>FWバージョン</label><input type="text" id="reg-fw-ver" class="w-full rounded-2xl p-4 font-bold bg-white" placeholder="7.2.4"></div>
                        <div class="space-y-2"><label>FW最終更新日</label><input type="date" id="reg-fw-date" class="w-full rounded-2xl p-4 font-bold bg-white"></div>
                        
                        <div class="space-y-2">
                            <label>自動ファームウェア設定</label>
                            <select id="reg-autofw" class="w-full rounded-2xl p-4 font-bold bg-white appearance-none">
                                <option value="未設定">未設定</option>
                                <option value="OFF">OFF (手動管理)</option>
                                <option value="ON">ON (自動更新有効)</option>
                            </select>
                        </div>
                        <div class="space-y-2">
                            <label>自動FW適用日 (リリースから何日後)</label>
                            <input type="number" id="reg-autofw-days" class="w-full rounded-2xl p-4 font-bold bg-white" placeholder="例: 7">
                        </div>

                        <div class="md:col-span-2 space-y-2">
                            <label>自動FW適用時間 (何時から何時の間)</label>
                            <div class="flex items-center gap-4">
                                <div class="flex-1 relative">
                                    <span class="absolute left-4 top-1 text-[9px] font-black text-slate-400 uppercase">開始時刻</span>
                                    <input type="time" id="reg-autofw-time-start" class="w-full rounded-2xl pt-6 pb-2 px-4 font-bold bg-white">
                                </div>
                                <span class="font-black text-slate-500 text-xl">～</span>
                                <div class="flex-1 relative">
                                    <span class="absolute left-4 top-1 text-[9px] font-black text-slate-400 uppercase">終了時刻</span>
                                    <input type="time" id="reg-autofw-time-end" class="w-full rounded-2xl pt-6 pb-2 px-4 font-bold bg-white">
                                </div>
                            </div>
                        </div>

                        <div class="md:col-span-1 space-y-2">
                            <label>相乗り部門システム (マスタから選択)</label>
                            <div class="flex gap-4 mt-1">
                                <select id="reg-dept-select" class="flex-1 rounded-2xl p-4 font-bold bg-white appearance-none"></select>
                                <button type="button" onclick="addDeptTag()" class="bg-slate-900 text-white px-8 rounded-2xl font-black hover:bg-slate-700 transition-all shadow-lg whitespace-nowrap">追加</button>
                            </div>
                        </div>
                        <div class="md:col-span-2">
                             <div id="selected-depts" class="flex flex-wrap p-6 bg-slate-100 rounded-[2rem] border-2 border-dashed border-slate-300 mt-4 min-h-[80px]"></div>
                        </div>
                    </div>
                    <div class="mt-12 flex justify-end gap-4">
                        <button type="button" id="cancel-edit-btn" onclick="cancelEdit()" class="hidden bg-slate-200 text-slate-600 px-10 py-4 rounded-2xl font-black hover:bg-slate-300 transition-all">キャンセル</button>
                        <button type="button" onclick="saveData()" class="bg-red-600 text-white px-16 py-4 rounded-2xl font-black shadow-xl hover:bg-red-700 transition-all transform hover:scale-105 flex items-center">
                            <i class="fas fa-cloud-upload-alt mr-3"></i> データベースへ保存
                        </button>
                    </div>
                </div>
            </div>

            <div id="content-news" class="hidden">
                <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                    <div class="lg:col-span-8 space-y-8">
                        <div class="bg-indigo-900 text-white p-10 rounded-[3rem] shadow-2xl relative overflow-hidden">
                            <div class="relative z-10">
                                <div class="flex justify-between items-center mb-10">
                                    <h3 class="text-2xl font-black italic tracking-tighter flex items-center"><i class="fas fa-microchip mr-4 text-indigo-400"></i>PSIRT INTELLIGENCE</h3>
                                    <span id="scan-badge" class="bg-green-500 px-6 py-2 rounded-full text-[10px] font-black online">LIVE FEED</span>
                                </div>
                                <div class="grid grid-cols-2 gap-8">
                                    <div class="bg-white/10 p-6 rounded-[2rem] border border-white/20 backdrop-blur-sm shadow-inner">
                                        <p class="text-[10px] text-indigo-300 font-black mb-4 uppercase tracking-widest">Detected Latest (Auto)</p>
                                        <div id="auto-fw-list" class="text-sm font-bold space-y-2 text-indigo-100"></div>
                                    </div>
                                    <div class="bg-white/10 p-6 rounded-[2rem] border border-white/20 backdrop-blur-sm shadow-inner">
                                        <p class="text-[10px] text-indigo-300 font-black mb-4 uppercase tracking-widest">Critical Vuln FW</p>
                                        <div id="auto-vuln-list" class="flex flex-wrap gap-2"></div>
                                    </div>
                                </div>
                            </div>
                            <i class="fas fa-shield-virus absolute bottom--10 right--10 text-[15rem] text-white/5 rotate-12"></i>
                        </div>
                        <h3 class="font-black text-xl mb-6 text-slate-700 flex items-center px-4"><i class="fas fa-rss text-orange-500 mr-3"></i>FortiGuard セキュリティ勧告</h3>
                        <div id="news-container" class="space-y-4"></div>
                    </div>
                    <div class="lg:col-span-4 space-y-6">
                        <div class="bg-white p-8 rounded-[2.5rem] border-2 border-slate-300 shadow-xl">
                            <h3 class="font-black text-sm mb-6 border-b-2 pb-4 text-slate-800">管理者推奨バージョン</h3>
                            <div id="manual-fw-display" class="space-y-3"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="content-settings" class="hidden">
                <div class="bg-white p-10 rounded-[3rem] border-2 border-slate-300 shadow-2xl">
                    <h2 class="text-2xl font-black mb-10 border-l-8 border-slate-900 pl-6 uppercase tracking-tight">マスタデータ管理</h2>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-12">
                        <div class="bg-slate-50 p-6 rounded-3xl border-2 border-slate-200">
                            <h3 class="text-[10px] font-black text-slate-500 uppercase mb-4">地域マスタ</h3>
                            <div class="flex gap-2 mb-4"><input type="text" id="new-master-region" class="flex-1 border rounded-xl p-3 text-xs font-bold outline-none bg-white"><button type="button" onclick="addMaster('region')" class="bg-slate-900 text-white px-4 rounded-xl text-xs font-black">＋</button></div>
                            <div id="settings-region-list" class="space-y-2 max-h-48 overflow-y-auto pr-2"></div>
                        </div>
                        <div class="bg-slate-50 p-6 rounded-3xl border-2 border-slate-200">
                            <h3 class="text-[10px] font-black text-slate-500 uppercase mb-4">型番マスタ</h3>
                            <div class="flex gap-2 mb-4"><input type="text" id="new-master-model" class="flex-1 border rounded-xl p-3 text-xs font-bold outline-none bg-white"><button type="button" onclick="addMaster('model')" class="bg-slate-900 text-white px-4 rounded-xl text-xs font-black">＋</button></div>
                            <div id="settings-model-list" class="space-y-2 max-h-48 overflow-y-auto pr-2"></div>
                        </div>
                        <div class="bg-red-50 p-6 rounded-3xl border-2 border-red-200">
                            <h3 class="text-[10px] font-black text-red-600 uppercase mb-4">相乗り部門システム</h3>
                            <div class="flex gap-2 mb-4"><input type="text" id="new-master-dept" class="flex-1 border border-red-200 rounded-xl p-3 text-xs font-bold outline-none bg-white"><button type="button" onclick="addMaster('dept')" class="bg-red-600 text-white px-4 rounded-xl text-xs font-black">＋</button></div>
                            <div id="settings-dept-list" class="space-y-2 max-h-48 overflow-y-auto pr-2"></div>
                        </div>
                        <div class="bg-slate-900 p-6 rounded-3xl text-white">
                            <h3 class="text-[10px] font-black text-slate-400 uppercase mb-4">管理者指定最新FW</h3>
                            <div class="space-y-3">
                                <input type="text" id="new-master-latest-branch" class="w-full border-none rounded-xl p-3 text-xs font-bold bg-white/10 text-white" placeholder="系統(7.2)">
                                <input type="text" id="new-master-latest-ver" class="w-full border-none rounded-xl p-3 text-xs font-bold bg-white/10 text-white" placeholder="最新(7.2.14)">
                                <button type="button" onclick="addLatestFwMaster()" class="w-full bg-blue-600 text-white py-3 rounded-xl text-xs font-black">登録保存</button>
                            </div>
                            <div id="settings-latest-fw-list" class="mt-6 space-y-2"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="log-modal" class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm hidden z-[150] flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-2xl rounded-[3rem] shadow-2xl overflow-hidden border-2 border-slate-300">
            <div class="bg-slate-900 p-8 text-white flex justify-between items-center">
                <div><h3 id="log-modal-title" class="text-2xl font-black">作業履歴</h3><p id="log-modal-subtitle" class="text-xs text-slate-500 font-bold mt-2 uppercase"></p></div>
                <button type="button" onclick="closeLogModal()" class="text-3xl hover:text-red-500 transition-colors font-thin">&times;</button>
            </div>
            <div class="p-8">
                <div class="bg-slate-100 p-6 rounded-[2rem] mb-6 border-2 border-slate-200">
                    <div class="grid grid-cols-3 gap-3">
                        <select id="log-input-action" class="border rounded-2xl p-4 text-sm font-bold bg-white outline-none"><option value="FW更新">FW更新</option><option value="設定変更">設定変更</option><option value="障害対応">障害対応</option><option value="定期点検">定期点検</option></select>
                        <input type="text" id="log-input-note" class="col-span-2 border rounded-2xl p-4 text-sm font-bold bg-white outline-none" placeholder="メモを入力...">
                        <button type="button" onclick="addLogEntry()" class="col-span-3 bg-red-600 text-white font-black py-4 rounded-2xl shadow-xl">履歴を追加</button>
                    </div>
                </div>
                <div id="log-timeline-container" class="relative border-l-4 border-slate-200 ml-6 space-y-6 max-h-[400px] overflow-y-auto pr-4 pb-4"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, addDoc, updateDoc, deleteDoc, doc, setDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA1natPUopWd-2SlfOAzJULYiSlJudm2Rs",
            authDomain: "fg-delivery-master.firebaseapp.com",
            projectId: "fg-delivery-master",
            storageBucket: "fg-delivery-master.firebasestorage.app",
            messagingSenderId: "752211748822",
            appId: "1:752211748822:web:754e385096f54e7ac2e677"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const inventoryCol = collection(db, "inventory");
        const masterDoc = doc(db, "config", "masters");

        window.inventoryData = [];
        window.masterRegions = [];
        window.masterModels = [];
        window.masterDepts = [];
        window.masterLatestFw = {};
        window.masterUsers = [];
        window.selectedDepts = [];
        window.selectedUsage = []; 
        window.currentUser = "";
        window.activeLogDeviceId = null;
        window.searchFilterType = null;
        const ADMIN_PW = "komayuu28";
        const REVEAL_PW = "sigma-sol2012";

        // 使用用途
        window.toggleUsage = (val) => {
            const index = window.selectedUsage.indexOf(val);
            if (index === -1) window.selectedUsage.push(val);
            else window.selectedUsage.splice(index, 1);
            updateUsageUI();
        };

        function updateUsageUI() {
            document.querySelectorAll('.usage-btn').forEach(btn => {
                const val = btn.id.replace('btn-usage-', '');
                if (window.selectedUsage.includes(val)) {
                    btn.classList.add('bg-blue-600', 'text-white', 'border-blue-700');
                    btn.classList.remove('bg-white', 'text-slate-700', 'border-slate-300');
                } else {
                    btn.classList.remove('bg-blue-600', 'text-white', 'border-blue-700');
                    btn.classList.add('bg-white', 'text-slate-700', 'border-slate-300');
                }
            });
        }

        window.runPsirtDeepScan = async () => {
            const badge = document.getElementById('scan-badge');
            const container = document.getElementById('news-container');
            if(!badge) return;
            try {
                const rssUrl = `https://www.fortiguard.com/rss/ir.xml?t=${Date.now()}`;
                const res = await fetch(`https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(rssUrl)}`);
                const data = await res.json();
                let latestMap = {};
                let vulnSet = new Set();
                container.innerHTML = data.items.map(item => {
                    const combined = (item.title + " " + item.description).toLowerCase();
                    const versions = combined.match(/\d+\.\d+\.\d+/g) || [];
                    versions.forEach(v => {
                        const [major, minor, patch] = v.split('.').map(n => parseInt(n));
                        const branch = `${major}.${minor}`;
                        if (combined.includes('vulnerability') || combined.includes('critical')) vulnSet.add(v);
                        if (!latestMap[branch] || patch > parseInt(latestMap[branch].split('.')[2])) latestMap[branch] = v;
                    });
                    return `<div class="bg-white p-8 rounded-[2rem] border-2 border-indigo-500 shadow-md">
                        <div class="text-[9px] text-slate-500 font-black mb-2 uppercase">${item.pubDate}</div>
                        <h4 class="font-black text-sm text-slate-800 leading-snug mb-4">${item.title}</h4>
                        <a href="${item.link}" target="_blank" class="text-[10px] bg-indigo-50 text-indigo-600 px-4 py-2 rounded-xl font-black inline-block border border-indigo-200">OFFICIAL REPORT</a>
                    </div>`;
                }).join('');
                window.autoLatestFw = latestMap;
                window.autoDetectedVuln = Array.from(vulnSet);
                document.getElementById('auto-fw-list').innerHTML = Object.entries(latestMap).map(([b,v])=>`<div>Branch ${b} -> <span class="text-green-500 font-bold">${v}</span></div>`).join('');
                document.getElementById('auto-vuln-list').innerHTML = window.autoDetectedVuln.map(v=>`<span class="bg-red-600 text-white text-[10px] px-3 py-1 rounded font-black">${v}</span>`).join('');
                calculateDashboard(); renderTable();
            } catch (e) { console.error(e); }
        };

        // リアルタイム同期（マスター）
        onSnapshot(masterDoc, (snap) => {
            if (snap.exists()) {
                const d = snap.data();
                window.masterRegions = d.regions || [];
                window.masterModels = d.models || [];
                window.masterDepts = d.depts || [];
                window.masterLatestFw = d.latestFw || {};
                window.masterUsers = d.users || [];
                updateDynamicLists();
                if(!document.getElementById('main-app').classList.contains('hidden')) refreshAllUI();
            } else { saveMasters(); }
        });

        // ログイン
        window.attemptLogin = () => {
            const u = document.getElementById('login-user').value;
            const p = document.getElementById('login-pass').value;
            const match = window.masterUsers.find(x => x.user === u && x.pass === p);
            if(match) {
                window.currentUser = u;
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('main-app').classList.remove('hidden');
                document.getElementById('display-username').innerText = u;
                
                // リアルタイム同期（在庫・機器）
                onSnapshot(inventoryCol, (snap) => {
                    window.inventoryData = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    refreshAllUI();
                });
                runPsirtDeepScan();
            } else { document.getElementById('login-error').classList.remove('hidden'); }
        };

        function refreshAllUI() {
            renderTable(); renderMasterLists(); calculateDashboard();
            document.getElementById('manual-fw-display').innerHTML = Object.entries(window.masterLatestFw).map(([b,v])=>`<div class="flex justify-between text-xs p-3 bg-slate-50 border-2 rounded-2xl font-black border-slate-200"><span>${b}.x</span> <span class="text-blue-600">${v}</span></div>`).join('');
        }

        function calculateDashboard() {
            const total = window.inventoryData.length;
            let vCnt = 0, pCnt = 0, aCnt = 0;
            const vulns = [...(window.masterVuln || []), ...(window.autoDetectedVuln || [])];
            window.inventoryData.forEach(i => {
                if(vulns.includes(i.fw_version)) vCnt++;
                if(i.auto_fw === "ON") aCnt++;
                const m = (i.fw_version || "").match(/^(\d+\.\d+)\.(\d+)$/);
                if(m) {
                    const l = window.masterLatestFw[m[1]] || (window.autoLatestFw ? window.autoLatestFw[m[1]] : null);
                    if(l && parseInt(l.split('.')[2]) > parseInt(m[2])) pCnt++;
                }
            });
            document.getElementById('stat-total').innerText = total;
            document.getElementById('stat-vuln').innerText = vCnt;
            document.getElementById('stat-pending').innerText = pCnt;
            document.getElementById('stat-auto-count').innerText = aCnt;
        }

        window.revealPassword = (id, btnElement) => {
            const i = window.inventoryData.find(x => x.id === id);
            if (btnElement.innerText.includes(i.password || '未設定')) {
                btnElement.innerHTML = '<i class="fas fa-eye mr-2"></i> ********';
                return;
            }
            const input = prompt("管理パスワードを表示するには、閲覧用パスワードを入力してください");
            if (input === REVEAL_PW) {
                btnElement.innerHTML = `<i class="fas fa-eye-slash mr-2"></i> ${i.password || '未設定'}`;
            } else if (input !== null) { alert("パスワードが違います。"); }
        };

        // 一覧レンダリング
        window.renderTable = () => {
            const term = document.getElementById('search-input').value.toLowerCase();
            const tbody = document.getElementById('inventory-tbody');
            if(!tbody) return;
            const vulns = [...(window.masterVuln || []), ...(window.autoDetectedVuln || [])];
            
            // 検索フィルタリング（過去データの互換性対応済み）
            let list = window.inventoryData.filter(i => {
                let uStr = "";
                if (Array.isArray(i.usage)) uStr = i.usage.join(',');
                else if (typeof i.usage === 'string') uStr = i.usage;
                
                return (i.customer||"").toLowerCase().includes(term) || 
                (i.serial||"").toLowerCase().includes(term) || 
                (i.region||"").toLowerCase().includes(term) ||
                uStr.toLowerCase().includes(term);
            });
            
            if(window.searchFilterType === 'vuln') list = list.filter(i => vulns.includes(i.fw_version));
            if(window.searchFilterType === 'update') {
                list = list.filter(i => {
                    const m = (i.fw_version||"").match(/^(\d+\.\d+)\.(\d+)$/);
                    if(!m) return false;
                    const l = window.masterLatestFw[m[1]] || (window.autoLatestFw ? window.autoLatestFw[m[1]] : null);
                    return l && parseInt(l.split('.')[2]) > parseInt(m[2]);
                });
            }

            tbody.innerHTML = list.map(item => {
                const isV = vulns.includes(item.fw_version);
                const isAuto = item.auto_fw === "ON";
                const rowCls = isV ? (isAuto ? 'auto-fw-active-row' : 'alert-row') : 'hover:bg-slate-100 transition-colors';
                let badge = "";
                const m = (item.fw_version||"").match(/^(\d+\.\d+)\.(\d+)$/);
                if(m) {
                    const l = window.masterLatestFw[m[1]] || (window.autoLatestFw ? window.autoLatestFw[m[1]] : null);
                    if(l && parseInt(l.split('.')[2]) > parseInt(m[2])) badge = `<div class="text-[9px] text-blue-700 font-black mt-2 bg-blue-100 px-3 py-1 rounded-full border border-blue-300 w-fit">LATEST: ${l}</div>`;
                }

                const timeStr = (item.auto_fw_time_start && item.auto_fw_time_end) ? `${item.auto_fw_time_start} ～ ${item.auto_fw_time_end}` : "-";

                // 過去データの互換性対応済み
                return `<tr class="${rowCls} group border-b border-slate-200">
                    <td class="px-8 py-6"><span class="font-black text-slate-900 text-sm">${item.customer}</span><br><span class="text-[10px] text-slate-500 font-black uppercase">${item.region||'-'}</span></td>
                    <td class="px-8 py-6"><div class="flex flex-wrap">${(Array.isArray(item.usage) ? item.usage : (item.usage ? [item.usage] : [])).map(u=>`<span class="usage-tag">${u}</span>`).join('')}</div></td>
                    <td class="px-8 py-6"><span class="font-bold text-xs text-slate-700">${item.model||'-'}</span><br><span class="text-[10px] text-slate-500 font-mono">${item.serial||'-'}</span></td>
                    <td class="px-8 py-6">
                        <div class="text-[10px] font-mono font-bold text-slate-600 mb-2">${item.ip||'-'}</div>
                        <button type="button" onclick="revealPassword('${item.id}', this)" class="text-slate-500 bg-white border-2 border-slate-300 px-4 py-2 rounded-xl text-[10px] font-black min-w-[100px] shadow-sm hover:text-slate-900">
                            <i class="fas fa-eye mr-2"></i> ********
                        </button>
                    </td>
                    <td class="px-8 py-6"><span class="${isV?'text-red-600 font-black':'font-black text-slate-700'}">${item.fw_version||'-'}</span>${badge}</td>
                    <td class="px-8 py-6">
                        <span class="text-[10px] font-black px-3 py-1.5 rounded-full ${isAuto?'bg-green-600 text-white':'bg-slate-200 text-slate-500'}">${item.auto_fw||'未設定'}</span>
                        ${isAuto ? `<div class="text-[9px] font-black text-slate-500 mt-2">${timeStr} (${item.auto_fw_days}日後)</div>` : ""}
                    </td>
                    <td class="px-8 py-6"><div class="flex flex-wrap">${(Array.isArray(item.depts) ? item.depts : (item.depts ? [item.depts] : [])).map(d=>`<span class="dept-tag">${d}</span>`).join('')}</div></td>
                    <td class="px-8 py-6 text-center">
                        <div class="flex justify-center space-x-2">
                            <button type="button" onclick="openLogModal('${item.id}')" class="w-10 h-10 bg-white border-2 border-slate-200 rounded-xl text-slate-500 shadow-sm hover:border-slate-400"><i class="fas fa-history"></i></button>
                            <button type="button" onclick="editData('${item.id}')" class="w-10 h-10 bg-white border-2 border-slate-200 rounded-xl text-blue-500 shadow-sm hover:border-blue-400"><i class="fas fa-edit"></i></button>
                            <button type="button" onclick="deleteData('${item.id}')" class="w-10 h-10 bg-white border-2 border-slate-200 rounded-xl text-red-400 shadow-sm hover:border-red-400"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    </td>
                </tr>`;
            }).join('');
        };

        // 保存処理
        window.saveData = async () => {
            const id = document.getElementById('edit-id').value;
            const item = {
                customer: document.getElementById('reg-customer').value,
                region: document.getElementById('reg-region').value,
                usage: [...window.selectedUsage],
                model: document.getElementById('reg-model').value,
                serial: document.getElementById('reg-serial').value,
                ip: document.getElementById('reg-ip').value,
                password: document.getElementById('reg-password').value,
                fw_version: document.getElementById('reg-fw-ver').value,
                fw_updated_at: document.getElementById('reg-fw-date').value,
                auto_fw: document.getElementById('reg-autofw').value,
                auto_fw_days: document.getElementById('reg-autofw-days').value,
                auto_fw_time_start: document.getElementById('reg-autofw-time-start').value,
                auto_fw_time_end: document.getElementById('reg-autofw-time-end').value,
                depts: [...window.selectedDepts],
                updatedAt: new Date().toISOString()
            };
            
            if(!item.customer) return alert("顧客名を入力してください");
            
            try {
                if(id) {
                    await updateDoc(doc(db, "inventory", id), item);
                } else {
                    await addDoc(inventoryCol, { ...item, logs: [] });
                }
                
                // 保存完了後にフィルター状態を確実リセット
                window.clearSearchFilter();
                cancelEdit();
                switchTab('list');
            } catch (e) { 
                console.error("Save error:", e);
                alert("保存に失敗しました: " + e.message); 
            }
        };

        window.editData = (id) => {
            const i = window.inventoryData.find(x => x.id === id);
            if(!i) return;
            document.getElementById('edit-id').value = id;
            document.getElementById('reg-customer').value = i.customer || "";
            document.getElementById('reg-region').value = i.region || "";
            
            // 既存データが文字列の場合の対策
            let currentUsage = i.usage || [];
            if (typeof currentUsage === 'string') currentUsage = [currentUsage];
            window.selectedUsage = [...currentUsage]; 
            updateUsageUI();
            
            document.getElementById('reg-model').value = i.model || "";
            document.getElementById('reg-serial').value = i.serial || "";
            document.getElementById('reg-ip').value = i.ip || "";
            document.getElementById('reg-password').value = i.password || "";
            document.getElementById('reg-fw-ver').value = i.fw_version || "";
            document.getElementById('reg-fw-date').value = i.fw_updated_at || "";
            document.getElementById('reg-autofw').value = i.auto_fw || "未設定";
            document.getElementById('reg-autofw-days').value = i.auto_fw_days || "";
            document.getElementById('reg-autofw-time-start').value = i.auto_fw_time_start || "";
            document.getElementById('reg-autofw-time-end').value = i.auto_fw_time_end || "";
            
            // 既存データが文字列の場合の対策
            let currentDepts = i.depts || [];
            if (typeof currentDepts === 'string') currentDepts = [currentDepts];
            window.selectedDepts = [...currentDepts];
            updateDeptTags();
            
            document.getElementById('form-title').innerText = "機器情報の編集";
            document.getElementById('cancel-edit-btn').classList.remove('hidden');
            switchTab('register');
        };

        window.deleteData = async (id) => { if(confirm("この機器情報を削除しますか？")) await deleteDoc(doc(db, "inventory", id)); };

        // ログ機能
        window.openLogModal = (id) => {
            window.activeLogDeviceId = id;
            const i = window.inventoryData.find(x => x.id === id);
            document.getElementById('log-modal-title').innerText = i.customer;
            document.getElementById('log-modal-subtitle').innerText = `${i.model} (SN: ${i.serial})`;
            renderTimeline();
            document.getElementById('log-modal').classList.remove('hidden');
        };
        window.closeLogModal = () => document.getElementById('log-modal').classList.add('hidden');
        window.addLogEntry = async () => {
            const note = document.getElementById('log-input-note').value;
            if(!note) return;
            const log = { date: new Date().toLocaleString('ja-JP'), user: window.currentUser, action: document.getElementById('log-input-action').value, note: note };
            await updateDoc(doc(db, "inventory", window.activeLogDeviceId), { logs: arrayUnion(log) });
            document.getElementById('log-input-note').value = "";
            renderTimeline();
        };
        function renderTimeline() {
            const i = window.inventoryData.find(x => x.id === window.activeLogDeviceId);
            document.getElementById('log-timeline-container').innerHTML = (i.logs || []).slice().reverse().map(l => `
                <div class="relative pl-10">
                    <div class="absolute -left-[11px] top-1.5 w-5 h-5 rounded-full bg-slate-900 border-4 border-white shadow-md"></div>
                    <div class="bg-white p-5 rounded-2xl border-2 border-slate-200 shadow-sm text-xs font-bold">
                        <div class="flex justify-between text-slate-500 mb-2 font-black uppercase"><span>${l.date}</span><span>BY ${l.user}</span></div>
                        <div class="text-slate-900 text-sm mb-1 font-black">${l.action}</div>
                        <div class="text-slate-600">${l.note}</div>
                    </div>
                </div>`).join('');
        }

        async function saveMasters() {
            await setDoc(masterDoc, { regions: window.masterRegions, models: window.masterModels, depts: window.masterDepts, latestFw: window.masterLatestFw, users: window.masterUsers });
        }
        window.addMaster = (type) => {
            const v = document.getElementById(`new-master-${type}`).value.trim();
            if(!v) return;
            if(type==='region') window.masterRegions.push(v);
            else if(type==='model') window.masterModels.push(v);
            else if(type==='dept') window.masterDepts.push(v);
            saveMasters(); document.getElementById(`new-master-${type}`).value = "";
        };
        window.removeMaster = (type, v) => {
            if(type==='region') window.masterRegions = window.masterRegions.filter(x=>x!==v);
            else if(type==='model') window.masterModels = window.masterModels.filter(x=>x!==v);
            else if(type==='dept') window.masterDepts = window.masterDepts.filter(x=>x!==v);
            saveMasters();
        };
        window.addLatestFwMaster = () => {
            const b = document.getElementById('new-master-latest-branch').value;
            const v = document.getElementById('new-master-latest-ver').value;
            if(b && v) { window.masterLatestFw[b] = v; saveMasters(); }
        };

        window.updateDynamicLists = () => {
            const rOpts = document.getElementById('region-options');
            const mOpts = document.getElementById('model-options');
            if(rOpts) rOpts.innerHTML = window.masterRegions.map(r => `<option value="${r}">`).join('');
            if(mOpts) mOpts.innerHTML = window.masterModels.map(m => `<option value="${m}">`).join('');
            const select = document.getElementById('reg-dept-select');
            if(select) select.innerHTML = '<option value="">登録済みの部門システムを選択...</option>' + window.masterDepts.map(d => `<option value="${d}">${d}</option>`).join('');
        };
        window.addDeptTag = () => {
            const val = document.getElementById('reg-dept-select').value;
            if(val && !window.selectedDepts.includes(val)) {
                window.selectedDepts.push(val);
                updateDeptTags();
            }
        };
        window.updateDeptTags = () => {
            document.getElementById('selected-depts').innerHTML = window.selectedDepts.map(s => `
                <span class="dept-tag bg-white shadow-sm border-slate-300 border-2">${s} 
                    <i class="fas fa-times cursor-pointer ml-2 text-red-400" onclick="removeDeptTag('${s}')"></i>
                </span>`).join('');
        };
        window.removeDeptTag = (s) => { window.selectedDepts = window.selectedDepts.filter(x=>x!==s); updateDeptTags(); };

        window.renderMasterLists = () => {
            const d = (arr, t) => arr.map(i => `<div class="flex justify-between bg-white p-2 border-2 border-slate-200 rounded-xl mb-1 text-[10px] font-black"><span>${i}</span><button type="button" onclick="removeMaster('${t}','${i}')" class="text-red-400">&times;</button></div>`).join('');
            document.getElementById('settings-region-list').innerHTML = d(window.masterRegions, 'region');
            document.getElementById('settings-model-list').innerHTML = d(window.masterModels, 'model');
            document.getElementById('settings-dept-list').innerHTML = d(window.masterDepts, 'dept');
            document.getElementById('settings-latest-fw-list').innerHTML = Object.entries(window.masterLatestFw).map(([b,v])=>`<div class="bg-white/10 p-2 rounded-lg text-[10px] font-bold flex justify-between shadow-sm border border-white/20"><span>${b}.x -> ${v}</span><button type="button" onclick="delete window.masterLatestFw['${b}']; saveMasters();" class="text-red-400 hover:text-red-600">&times;</button></div>`).join('');
        };

        window.switchTab = (t) => {
            ['list', 'register', 'news', 'settings'].forEach(id => {
                const el = document.getElementById(`content-${id}`);
                if (el) el.classList.add('hidden');
                const btn = document.getElementById(`tab-${id}`);
                if (btn) btn.className = "px-8 py-2.5 rounded-xl font-black text-slate-600 hover:text-slate-900 transition-all";
            });
            document.getElementById(`content-${t}`).classList.remove('hidden');
            const targetBtn = document.getElementById(`tab-${t}`);
            if (targetBtn) {
                targetBtn.className = "px-8 py-2.5 rounded-xl font-black tab-active transition-all shadow-sm";
                if (t === 'settings') targetBtn.style.display = 'block';
            }
        };

        // 検索フィルター強制リセット機能
        window.setSearchFilter = (t) => { 
            window.searchFilterType = t; 
            document.getElementById('clear-filter-btn').classList.remove('hidden'); 
            renderTable(); 
        };
        window.clearSearchFilter = () => { 
            window.searchFilterType = null; 
            const btn = document.getElementById('clear-filter-btn');
            if(btn) btn.classList.add('hidden'); 
            const input = document.getElementById('search-input');
            if(input) input.value = "";
            renderTable(); 
        };
        
        // フォームのリセット処理
        window.cancelEdit = () => { 
            document.getElementById('edit-id').value = ""; 
            document.getElementById('form-title').innerText = "機器情報の登録"; 
            document.getElementById('cancel-edit-btn').classList.add('hidden'); 
            
            document.getElementById('reg-customer').value = "";
            document.getElementById('reg-region').value = "";
            document.getElementById('reg-model').value = "";
            document.getElementById('reg-serial').value = "";
            document.getElementById('reg-ip').value = "";
            document.getElementById('reg-password').value = "";
            document.getElementById('reg-fw-ver').value = "";
            document.getElementById('reg-fw-date').value = "";
            document.getElementById('reg-autofw').value = "未設定";
            document.getElementById('reg-autofw-days').value = "";
            document.getElementById('reg-autofw-time-start').value = "";
            document.getElementById('reg-autofw-time-end').value = "";
            
            window.selectedUsage = []; 
            updateUsageUI();
            window.selectedDepts = []; 
            updateDeptTags(); 
        };
        
        window.enterSettings = () => {
            if(prompt("管理者パスワードを入力してください") === ADMIN_PW) {
                const settingTab = document.getElementById('tab-settings');
                settingTab.style.display = 'block';
                settingTab.classList.remove('hidden');
                switchTab('settings');
            }
        };
    </script>
</body>
</html>