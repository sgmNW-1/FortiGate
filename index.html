<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FG 納品管理マスター v20 - 完全復旧版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans JP', sans-serif; background-color: #f1f5f9; color: #1e293b; }
        .tab-active { border-bottom: 3px solid #dc2626; color: #dc2626; background-color: #fff; }
        .dept-tag { display: inline-flex; align-items: center; background: #fee2e2; color: #991b1b; padding: 2px 8px; border-radius: 4px; margin: 2px; font-size: 0.75rem; border: 1px solid #fecaca; }
        tr:hover .action-btns { opacity: 1; }
        .action-btns { opacity: 0.2; transition: opacity 0.2s; }
        .sync-indicator { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .online { background-color: #10b981; box-shadow: 0 0 8px #10b981; animation: pulse 2s infinite; }
        .offline { background-color: #ef4444; box-shadow: 0 0 8px #ef4444; }
        .alert-row { background-color: #fff1f2 !important; border-left: 4px solid #ef4444; }
        .auto-alert-row { background-color: #fff7ed !important; border-left: 4px solid #f97316; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        .scanning-pulse { animation: pulse 1.5s infinite; }
        .login-bg { background: linear-gradient(-45deg, #0f172a, #1e293b, #334155, #0f172a); background-size: 400% 400%; animation: gradientBG 15s ease infinite; }
        @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        .modal-enter { animation: modalFadeIn 0.3s ease-out; }
        @keyframes modalFadeIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="min-h-screen">

    <div id="login-screen" class="fixed inset-0 login-bg flex items-center justify-center z-[200]">
        <div class="bg-white p-10 rounded-3xl shadow-2xl w-full max-w-md border-t-8 border-red-600">
            <div class="text-center mb-8">
                <div class="bg-red-50 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4 shadow-inner"><i class="fas fa-users-cog text-4xl text-red-600"></i></div>
                <h1 class="text-2xl font-bold text-slate-800 tracking-tighter">FG 納品管理マスター</h1>
                <p class="text-xs text-slate-500 mt-2">v20 Stable Full-Function</p>
            </div>
            <div class="space-y-5">
                <div><label class="block text-sm font-bold text-slate-700 mb-1">ユーザー名</label><input type="text" id="login-user" class="w-full border border-slate-300 rounded-xl py-3 px-4 outline-none focus:ring-2 focus:ring-red-500 bg-slate-50"></div>
                <div><label class="block text-sm font-bold text-slate-700 mb-1">パスワード</label><input type="password" id="login-pass" class="w-full border border-slate-300 rounded-xl py-3 px-4 outline-none focus:ring-2 focus:ring-red-500 bg-slate-50"></div>
                <button onclick="attemptLogin()" class="w-full bg-slate-900 text-white font-bold py-4 rounded-xl shadow-lg hover:bg-slate-800 transition-colors">ログイン</button>
                <div id="login-status-msg" class="text-center text-[10px] text-slate-500 mt-2">DB待機中...</div>
                <div id="login-error" class="hidden text-center text-xs text-red-600 font-bold bg-red-50 p-2 rounded-lg border border-red-200 mt-4">認証に失敗しました。</div>
            </div>
        </div>
    </div>

    <div id="main-app" class="hidden pb-10">
        <nav class="bg-slate-900 text-white shadow-xl sticky top-0 z-50">
            <div class="container mx-auto px-6 py-4 flex justify-between items-center">
                <div class="flex items-center space-x-3 cursor-pointer" onclick="location.reload()">
                    <div class="bg-red-600 p-2 rounded-lg"><i class="fas fa-shield-virus text-white text-xl"></i></div>
                    <div>
                        <span class="text-xl font-bold tracking-tighter">FG 納品管理 <span class="text-red-500">Master v20</span></span>
                        <p class="text-[10px] text-slate-400 leading-none mt-1"><span id="cloud-sync-indicator" class="sync-indicator online"></span>クラウド同期中</p>
                    </div>
                </div>
                <div class="flex items-center space-x-6">
                    <span class="text-xs text-slate-400"><i class="fas fa-user-circle mr-1 text-green-400"></i><span id="display-username"></span></span>
                    <button onclick="enterSettings()" class="text-slate-400 hover:text-white"><i class="fas fa-cog text-xl"></i></button>
                </div>
            </div>
        </nav>

        <div class="container mx-auto px-4 py-8">
            <div id="dashboard-area" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                <div class="bg-white p-5 rounded-2xl border shadow-sm border-l-4 border-l-blue-500">
                    <div class="text-slate-500 text-[10px] font-bold uppercase mb-1">管理デバイス合計</div>
                    <div class="flex items-end justify-between"><div class="text-3xl font-black text-slate-800" id="stat-total">0</div><i class="fas fa-server text-blue-100 text-2xl"></i></div>
                </div>
                <div class="bg-white p-5 rounded-2xl border shadow-sm border-l-4 border-l-red-500 cursor-pointer hover:bg-red-50" onclick="setSearchFilter('vuln')">
                    <div class="text-slate-500 text-[10px] font-bold uppercase mb-1">脆弱性リスク</div>
                    <div class="flex items-end justify-between"><div class="text-3xl font-black text-red-600" id="stat-vuln">0</div><i class="fas fa-biohazard text-red-100 text-2xl"></i></div>
                </div>
                <div class="bg-white p-5 rounded-2xl border shadow-sm border-l-4 border-l-orange-500 cursor-pointer hover:bg-orange-50" onclick="setSearchFilter('update')">
                    <div class="text-slate-500 text-[10px] font-bold uppercase mb-1">更新推奨</div>
                    <div class="flex items-end justify-between"><div class="text-3xl font-black text-orange-600" id="stat-pending">0</div><i class="fas fa-arrow-alt-circle-up text-orange-100 text-2xl"></i></div>
                </div>
                <div class="bg-white p-5 rounded-2xl border shadow-sm border-l-4 border-l-green-500">
                    <div class="text-slate-500 text-[10px] font-bold uppercase mb-1">自動FW有効数</div>
                    <div class="flex items-end justify-between"><div class="text-3xl font-black text-green-600" id="stat-auto-count">0</div><i class="fas fa-robot text-green-100 text-2xl"></i></div>
                </div>
            </div>

            <div class="flex space-x-2 mb-8 bg-slate-200 p-1 rounded-xl w-fit">
                <button onclick="switchTab('list')" id="tab-list" class="px-6 py-2.5 rounded-lg font-bold tab-active">納品一覧</button>
                <button onclick="switchTab('register')" id="tab-register" class="px-6 py-2.5 rounded-lg font-bold text-gray-600">機器登録</button>
                <button onclick="switchTab('news')" id="tab-news" class="px-6 py-2.5 rounded-lg font-bold text-gray-600">解析・ニュース</button>
                <button onclick="switchTab('settings')" id="tab-settings" class="hidden px-6 py-2.5 rounded-lg font-bold text-gray-600">管理者設定</button>
            </div>

            <div id="content-list">
                <div class="mb-6 flex flex-wrap gap-4 items-center">
                    <div class="relative flex-1 min-w-[300px]">
                        <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-slate-400"><i class="fas fa-search"></i></span>
                        <input type="text" id="search-input" onkeyup="renderTable()" class="w-full border border-slate-300 rounded-xl py-3 pl-10 pr-4 outline-none focus:ring-2 focus:ring-red-500" placeholder="顧客名、SN、FW Verで検索...">
                    </div>
                    <button onclick="clearSearchFilter()" id="clear-filter-btn" class="hidden text-xs bg-slate-200 px-4 py-3 rounded-xl font-bold">フィルタ解除 &times;</button>
                </div>
                <div class="bg-white rounded-2xl shadow-sm border overflow-x-auto">
                    <table class="w-full text-left min-w-[1200px]">
                        <thead class="bg-slate-50 border-b text-[11px] font-bold text-slate-500 uppercase">
                            <tr>
                                <th class="px-6 py-4">納品先 / 地域</th>
                                <th class="px-6 py-4">型番 / シリアル</th>
                                <th class="px-6 py-4">管理IP</th>
                                <th class="px-6 py-4">FW Ver / 推奨</th>
                                <th class="px-6 py-4">自動FW</th>
                                <th class="px-6 py-4">相乗り部門システム</th>
                                <th class="px-6 py-4 text-center">操作</th>
                            </tr>
                        </thead>
                        <tbody id="inventory-tbody" class="divide-y divide-slate-100 text-sm"></tbody>
                    </table>
                </div>
            </div>

            <div id="content-register" class="hidden">
                <div class="max-w-4xl mx-auto bg-white p-8 rounded-3xl shadow-xl border">
                    <h2 id="form-title" class="text-2xl font-bold mb-8 border-l-4 border-red-600 pl-4 text-slate-800">機器情報の登録</h2>
                    <input type="hidden" id="edit-id" value="">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div><label class="text-sm font-bold text-slate-700">納品先名 *</label><input type="text" id="reg-customer" class="w-full border rounded-xl p-3 mt-1 outline-none focus:ring-2 focus:ring-red-500"></div>
                        <div><label class="text-sm font-bold text-slate-700">地域</label><input list="region-options" id="reg-region" class="w-full border rounded-xl p-3 mt-1 outline-none"></div>
                        <div><label class="text-sm font-bold text-slate-700">型番</label><input list="model-options" id="reg-model" class="w-full border rounded-xl p-3 mt-1 outline-none"></div>
                        <div><label class="text-sm font-bold text-slate-700">シリアルナンバー</label><input type="text" id="reg-serial" class="w-full border rounded-xl p-3 mt-1 outline-none"></div>
                        <div><label class="text-sm font-bold text-slate-700">管理IP</label><input type="text" id="reg-ip" class="w-full border rounded-xl p-3 mt-1 outline-none"></div>
                        <div><label class="text-sm font-bold text-slate-700">FWバージョン</label><input type="text" id="reg-fw-ver" class="w-full border rounded-xl p-3 mt-1 outline-none" placeholder="7.2.4"></div>
                        <div><label class="text-sm font-bold text-slate-700">FW最終更新日</label><input type="date" id="reg-fw-date" class="w-full border rounded-xl p-3 mt-1 outline-none"></div>
                        <div>
                            <label class="text-sm font-bold text-slate-700">自動ファームウェア設定</label>
                            <select id="reg-autofw" class="w-full border rounded-xl p-3 mt-1 outline-none bg-white">
                                <option value="未設定">未設定</option>
                                <option value="OFF">OFF</option>
                                <option value="ON">ON</option>
                            </select>
                        </div>
                        <div><label class="text-sm font-bold text-slate-700">ログインPW</label><input type="text" id="reg-pw" class="w-full border rounded-xl p-3 mt-1 outline-none"></div>
                        <div class="md:col-span-2">
                            <label class="text-sm font-bold text-slate-700">相乗り部門システム</label>
                            <div class="flex gap-2 mt-2">
                                <select id="reg-dept-select" class="flex-1 border rounded-xl p-3 outline-none bg-white"></select>
                                <button onclick="addDeptTag()" class="bg-slate-800 text-white px-8 rounded-xl font-bold hover:bg-slate-700">追加</button>
                            </div>
                            <div id="selected-depts" class="flex flex-wrap p-4 bg-slate-50 rounded-2xl border border-dashed mt-3 min-h-[70px]"></div>
                        </div>
                    </div>
                    <div class="mt-10 flex justify-end space-x-4">
                        <button id="cancel-edit-btn" onclick="cancelEdit()" class="hidden bg-slate-100 px-8 py-3 rounded-xl font-bold">キャンセル</button>
                        <button onclick="saveData()" class="bg-red-600 text-white px-12 py-3 rounded-xl font-bold shadow-lg hover:bg-red-700 transition-all flex items-center"><i class="fas fa-save mr-2"></i>保存してクラウド同期</button>
                    </div>
                </div>
            </div>

            <div id="content-news" class="hidden">
                <div class="mb-8 bg-indigo-950 text-white p-6 rounded-3xl shadow-2xl relative overflow-hidden">
                    <div class="relative z-10">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-xl font-bold"><i class="fas fa-brain mr-2 text-indigo-400"></i>PSIRT 解析エンジン</h3>
                            <div class="flex items-center space-x-4">
                                <button onclick="runPsirtDeepScan()" class="text-[10px] bg-white/10 hover:bg-white/20 px-3 py-1 rounded-full transition-all">手動再スキャン</button>
                                <span id="scan-badge" class="bg-indigo-500 px-3 py-1 rounded-full text-[10px] font-black scanning-pulse">ANALYZING...</span>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-white/5 p-4 rounded-2xl border border-white/10">
                                <h4 class="text-[10px] font-bold text-indigo-300 uppercase mb-2">自動検知した最新FW</h4>
                                <div id="auto-fw-list" class="space-y-1 text-xs"></div>
                            </div>
                            <div class="bg-white/5 p-4 rounded-2xl border border-white/10">
                                <h4 class="text-[10px] font-bold text-indigo-300 uppercase mb-2">自動検知した脆弱性FW</h4>
                                <div id="auto-vuln-list" class="flex flex-wrap"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-2">
                        <h3 class="font-bold text-lg mb-4 text-slate-700 flex items-center"><i class="fas fa-rss text-orange-500 mr-2"></i>FortiGuard 最新アドバイザリ</h3>
                        <div id="news-container" class="space-y-4"></div>
                    </div>
                    <div class="space-y-6">
                        <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                            <h3 class="text-slate-700 font-bold mb-3 border-b pb-2 text-sm"><i class="fas fa-check-circle mr-2 text-blue-500"></i>管理者指定 最新FW</h3>
                            <div id="manual-fw-display" class="space-y-2"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="content-settings" class="hidden">
                <div class="max-w-6xl mx-auto bg-white p-8 rounded-3xl border shadow-xl">
                    <h2 class="text-2xl font-bold mb-8 border-l-4 border-slate-800 pl-4">マスタ・システム設定</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div class="bg-slate-50 p-4 rounded-xl border">
                            <h3 class="font-bold mb-4 text-xs uppercase text-slate-500">地域マスタ</h3>
                            <div class="flex gap-2 mb-4"><input type="text" id="new-master-region" class="flex-1 border rounded-lg p-2 text-xs outline-none"><button onclick="addMaster('region')" class="bg-slate-800 text-white px-3 py-1 rounded-lg text-xs">追加</button></div>
                            <div id="settings-region-list" class="space-y-1 max-h-32 overflow-y-auto"></div>
                        </div>
                        <div class="bg-slate-50 p-4 rounded-xl border">
                            <h3 class="font-bold mb-4 text-xs uppercase text-slate-500">型番マスタ</h3>
                            <div class="flex gap-2 mb-4"><input type="text" id="new-master-model" class="flex-1 border rounded-lg p-2 text-xs outline-none"><button onclick="addMaster('model')" class="bg-slate-800 text-white px-3 py-1 rounded-lg text-xs">追加</button></div>
                            <div id="settings-model-list" class="space-y-1 max-h-32 overflow-y-auto"></div>
                        </div>
                        <div class="bg-slate-50 p-4 rounded-xl border">
                            <h3 class="font-bold mb-4 text-xs uppercase text-slate-500">相乗り部門システム</h3>
                            <div class="flex gap-2 mb-4"><input type="text" id="new-master-dept" class="flex-1 border rounded-lg p-2 text-xs outline-none"><button onclick="addMaster('dept')" class="bg-slate-800 text-white px-3 py-1 rounded-lg text-xs">追加</button></div>
                            <div id="settings-dept-list" class="space-y-1 max-h-32 overflow-y-auto"></div>
                        </div>
                        <div class="bg-red-50 p-4 rounded-xl border border-red-100">
                            <h3 class="font-bold mb-4 text-xs uppercase text-red-500">要注意FW (手動)</h3>
                            <div class="flex gap-2 mb-4"><input type="text" id="new-master-vuln" class="flex-1 border rounded-lg p-2 text-xs outline-none"><button onclick="addMaster('vuln')" class="bg-red-600 text-white px-3 py-1 rounded-lg text-xs">追加</button></div>
                            <div id="settings-vuln-list" class="space-y-1 max-h-32 overflow-y-auto"></div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 border-t pt-8">
                        <div class="bg-blue-50 p-6 rounded-2xl border border-blue-100">
                            <h3 class="font-bold mb-4 text-blue-800 text-sm">最新FW指定</h3>
                            <div class="flex gap-2 mb-4">
                                <input type="text" id="new-master-latest-branch" class="w-1/3 border rounded-lg p-2 text-xs outline-none" placeholder="系統(7.2)">
                                <input type="text" id="new-master-latest-ver" class="flex-1 border rounded-lg p-2 text-xs outline-none" placeholder="最新版(7.2.14)">
                                <button onclick="addLatestFwMaster()" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-xs font-bold">登録</button>
                            </div>
                            <div id="settings-latest-fw-list" class="grid grid-cols-1 sm:grid-cols-2 gap-2"></div>
                        </div>
                        <div class="bg-indigo-50 p-6 rounded-2xl border border-indigo-100">
                            <h3 class="font-bold mb-4 text-indigo-800 text-sm">管理ユーザー</h3>
                            <div class="flex gap-2 mb-4">
                                <input type="text" id="new-master-user" class="w-1/3 border rounded-lg p-2 text-xs outline-none" placeholder="ID">
                                <input type="text" id="new-master-pass" class="flex-1 border rounded-lg p-2 text-xs outline-none" placeholder="PW">
                                <button onclick="addMasterUser()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-xs font-bold">追加</button>
                            </div>
                            <div id="settings-user-list" class="grid grid-cols-1 sm:grid-cols-2 gap-2"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="log-modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden z-[150] flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-2xl rounded-3xl shadow-2xl overflow-hidden modal-enter">
            <div class="bg-slate-900 p-6 text-white flex justify-between items-center">
                <div><h3 id="log-modal-title" class="text-xl font-bold">作業履歴</h3><p id="log-modal-subtitle" class="text-xs text-slate-400 mt-1"></p></div>
                <button onclick="closeLogModal()" class="text-2xl hover:text-red-500 transition-colors">&times;</button>
            </div>
            <div class="p-6">
                <div class="bg-slate-50 p-4 rounded-2xl mb-6 border">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                        <select id="log-input-action" class="border rounded-xl p-2.5 text-sm bg-white outline-none"><option value="FWアップデート">FWアップデート</option><option value="設定変更">設定変更</option><option value="ポリシー追加">ポリシー追加</option><option value="障害対応">障害対応</option><option value="その他">その他</option></select>
                        <input type="text" id="log-input-note" class="md:col-span-2 border rounded-xl p-2.5 text-sm bg-white outline-none" placeholder="メモを入力...">
                        <button onclick="addLogEntry()" class="md:col-span-3 bg-slate-800 text-white font-bold py-2.5 rounded-xl hover:bg-slate-700">保存</button>
                    </div>
                </div>
                <div id="log-timeline-container" class="relative border-l-2 border-slate-200 ml-4 space-y-6 pb-4 max-h-[400px] overflow-y-auto pr-2"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, addDoc, updateDoc, deleteDoc, doc, setDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA1natPUopWd-2SlfOAzJULYiSlJudm2Rs",
            authDomain: "fg-delivery-master.firebaseapp.com",
            projectId: "fg-delivery-master",
            storageBucket: "fg-delivery-master.firebasestorage.app",
            messagingSenderId: "752211748822",
            appId: "1:752211748822:web:754e385096f54e7ac2e677"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const inventoryCol = collection(db, "inventory");
        const masterDoc = doc(db, "config", "masters");

        // グローバル
        window.inventoryData = [];
        window.masterRegions = [];
        window.masterDepts = [];
        window.masterModels = [];
        window.masterVuln = [];
        window.masterLatestFw = {};
        window.masterUsers = [];
        window.autoDetectedVuln = [];
        window.autoLatestFw = {};
        window.selectedDepts = [];
        window.currentUser = "";
        window.activeLogDeviceId = null;
        window.searchFilterType = null;

        const ADMIN_PW = "komayuu28";

        // ==========================================
        // PSIRT解析 (修正版: CORS・タイムアウト・ロジック強化)
        // ==========================================
        window.runPsirtDeepScan = async () => {
            const container = document.getElementById('news-container');
            const badge = document.getElementById('scan-badge');
            badge.innerText = "SCANNING..."; badge.className = "bg-blue-600 px-3 py-1 rounded-full text-[10px] font-black scanning-pulse";

            try {
                // rss2json APIを使用 (キャッシュ回避のためtimestamp付与)
                const rssUrl = "https://www.fortiguard.com/rss/ir.xml";
                const response = await fetch(`https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(rssUrl)}&t=${Date.now()}`);
                const data = await response.json();

                if (data.status !== 'ok') throw new Error("Fetch Failed");

                let latestMap = {};
                let vulnSet = new Set();

                container.innerHTML = data.items.map(item => {
                    const fullText = (item.title + " " + item.description).toLowerCase();
                    // バージョン番号抽出 (v7.2.4 や 7.2.4 に対応)
                    const matches = fullText.match(/\d+\.\d+\.\d+/g) || [];
                    
                    matches.forEach(v => {
                        const [major, minor, patch] = v.split('.').map(n => parseInt(n));
                        const branch = `${major}.${minor}`;

                        // タイトルにVulnerability/PSIRTがあれば脆弱性リストへ
                        if (fullText.includes('vulnerability') || fullText.includes('psirt')) {
                            vulnSet.add(v);
                        }

                        // 系統別の最新を推測
                        if (!latestMap[branch] || patch > parseInt(latestMap[branch].split('.')[2])) {
                            latestMap[branch] = v;
                        }
                    });

                    return `<div class="bg-white p-4 rounded-xl border border-l-4 border-l-indigo-400">
                        <div class="text-[9px] text-slate-400 font-bold mb-1">${item.pubDate}</div>
                        <h4 class="font-bold text-sm text-slate-800 mb-2">${item.title}</h4>
                        <a href="${item.link}" target="_blank" class="text-[10px] bg-indigo-50 text-indigo-600 px-2 py-1 rounded font-bold">公式詳細を確認</a>
                    </div>`;
                }).join('');

                window.autoLatestFw = latestMap;
                window.autoDetectedVuln = Array.from(vulnSet);

                document.getElementById('auto-fw-list').innerHTML = Object.entries(latestMap).map(([b,v])=>`<div>系統 ${b}: <span class="text-green-400 font-bold">${v}</span></div>`).join('');
                document.getElementById('auto-vuln-list').innerHTML = window.autoDetectedVuln.map(v=>`<span class="bg-red-500/20 text-red-200 text-[9px] px-2 py-0.5 rounded m-0.5">${v}</span>`).join('');
                
                badge.innerText = "ONLINE"; badge.className = "bg-green-600 px-3 py-1 rounded-full text-[10px] font-black";
                calculateDashboard(); renderTable();
            } catch (e) {
                console.error(e);
                badge.innerText = "OFFLINE"; badge.className = "bg-red-600 px-3 py-1 rounded-full text-[10px] font-black";
            }
        };

        // ==========================================
        // Firebase コア
        // ==========================================
        onSnapshot(masterDoc, (snap) => {
            if (snap.exists()) {
                const d = snap.data();
                window.masterRegions = d.regions || [];
                window.masterDepts = d.depts || [];
                window.masterModels = d.models || [];
                window.masterVuln = d.vuln || [];
                window.masterLatestFw = d.latestFw || {};
                window.masterUsers = d.users || [];
                document.getElementById('login-status-msg').innerText = "Database Connected.";
                if(!document.getElementById('main-app').classList.contains('hidden')) refreshAllUI();
            } else { saveMasters(); }
        });

        window.attemptLogin = () => {
            const u = document.getElementById('login-user').value;
            const p = document.getElementById('login-pass').value;
            const userMatch = window.masterUsers.find(x => x.user === u && x.pass === p);
            if(userMatch) {
                window.currentUser = u;
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('main-app').classList.remove('hidden');
                document.getElementById('display-username').innerText = u;
                initApp();
            } else { document.getElementById('login-error').classList.remove('hidden'); }
        };

        function initApp() {
            onSnapshot(inventoryCol, (snap) => {
                window.inventoryData = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                refreshAllUI();
            });
            runPsirtDeepScan();
        }

        function refreshAllUI() {
            renderTable(); renderMasterLists(); renderLatestMaster(); updateDynamicLists(); calculateDashboard();
            document.getElementById('manual-fw-display').innerHTML = Object.entries(window.masterLatestFw).map(([b,v])=>`<div class="flex justify-between text-xs p-2 bg-slate-50 border rounded"><b>${b}.x</b> <span class="text-blue-600 font-bold">${v}</span></div>`).join('');
        }

        function calculateDashboard() {
            const total = window.inventoryData.length;
            let vCnt = 0; let pCnt = 0; let aCnt = 0;
            const vulns = [...window.masterVuln, ...window.autoDetectedVuln];
            window.inventoryData.forEach(i => {
                if(vulns.includes(i.fw_version)) vCnt++;
                if(i.auto_fw === "ON") aCnt++;
                const m = (i.fw_version || "").match(/^(\d+\.\d+)\.(\d+)$/);
                if(m) {
                    const l = window.masterLatestFw[m[1]] || window.autoLatestFw[m[1]];
                    if(l && parseInt(l.split('.')[2]) > parseInt(m[2])) pCnt++;
                }
            });
            document.getElementById('stat-total').innerText = total;
            document.getElementById('stat-vuln').innerText = vCnt;
            document.getElementById('stat-pending').innerText = pCnt;
            document.getElementById('stat-auto-count').innerText = aCnt;
        }

        window.renderTable = () => {
            const term = document.getElementById('search-input').value.toLowerCase();
            const tbody = document.getElementById('inventory-tbody');
            const vulns = [...window.masterVuln, ...window.autoDetectedVuln];
            
            let list = window.inventoryData.filter(i => (i.customer||"").toLowerCase().includes(term) || (i.serial||"").toLowerCase().includes(term) || (i.fw_version||"").toLowerCase().includes(term));
            
            if(window.searchFilterType === 'vuln') list = list.filter(i => vulns.includes(i.fw_version));
            if(window.searchFilterType === 'update') {
                list = list.filter(i => {
                    const m = (i.fw_version||"").match(/^(\d+\.\d+)\.(\d+)$/);
                    if(!m) return false;
                    const l = window.masterLatestFw[m[1]] || window.autoLatestFw[m[1]];
                    return l && parseInt(l.split('.')[2]) > parseInt(m[2]);
                });
            }

            tbody.innerHTML = list.map(item => {
                const isV = vulns.includes(item.fw_version);
                const rCls = isV ? (item.auto_fw === "ON" ? "auto-alert-row" : "alert-row") : "hover:bg-slate-50";
                
                let badge = "";
                const m = (item.fw_version||"").match(/^(\d+\.\d+)\.(\d+)$/);
                if(m) {
                    const l = window.masterLatestFw[m[1]] || window.autoLatestFw[m[1]];
                    if(l && parseInt(l.split('.')[2]) > parseInt(m[2])) badge = `<div class="text-[9px] text-blue-600 font-bold mt-1 bg-blue-50 px-2 py-0.5 rounded border border-blue-100">推奨: ${l}</div>`;
                }

                return `<tr class="${rCls} group">
                    <td class="px-6 py-4"><b>${item.customer}</b><br><span class="text-[10px] text-slate-400">${item.region||'-'}</span></td>
                    <td class="px-6 py-4"><span class="text-xs font-mono font-bold">${item.model||'-'}</span><br><span class="text-[10px] text-slate-400">${item.serial||'-'}</span></td>
                    <td class="px-6 py-4 font-mono text-xs">${item.ip||'-'}</td>
                    <td class="px-6 py-4"><span class="${isV?'text-red-600 font-black':'font-bold'}">${item.fw_version||'-'}</span>${badge}</td>
                    <td class="px-6 py-4 text-[10px] font-bold ${item.auto_fw==='ON'?'text-green-600':'text-slate-400'}">${item.auto_fw || '未設定'}</td>
                    <td class="px-6 py-4"><div class="flex flex-wrap">${(item.depts||[]).map(d=>`<span class="dept-tag">${d}</span>`).join('')}</div></td>
                    <td class="px-6 py-4 text-center">
                        <div class="action-btns flex justify-center space-x-1">
                            <button onclick="openLogModal('${item.id}')" class="p-2 text-slate-400 hover:text-slate-900" title="履歴"><i class="fas fa-history"></i></button>
                            <button onclick="editData('${item.id}')" class="p-2 text-blue-400 hover:text-blue-600" title="編集"><i class="fas fa-edit"></i></button>
                            <button onclick="deleteData('${item.id}')" class="p-2 text-red-300 hover:text-red-500" title="削除"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    </td>
                </tr>`;
            }).join('');
        };

        // 保存・編集・追加ロジック
        window.saveData = async () => {
            const id = document.getElementById('edit-id').value;
            const item = {
                customer: document.getElementById('reg-customer').value,
                region: document.getElementById('reg-region').value,
                model: document.getElementById('reg-model').value,
                serial: document.getElementById('reg-serial').value,
                ip: document.getElementById('reg-ip').value,
                fw_version: document.getElementById('reg-fw-ver').value,
                fw_updated_at: document.getElementById('reg-fw-date').value,
                auto_fw: document.getElementById('reg-autofw').value,
                pw: document.getElementById('reg-pw').value,
                depts: [...window.selectedDepts],
                updatedAt: new Date()
            };
            if(!item.customer) return alert("顧客名は必須です");
            try {
                if(id) await updateDoc(doc(db, "inventory", id), item);
                else await addDoc(inventoryCol, { ...item, logs: [] });
                cancelEdit(); switchTab('list');
            } catch (e) { alert("保存エラー: " + e); }
        };

        window.editData = (id) => {
            const i = window.inventoryData.find(x => x.id === id);
            document.getElementById('edit-id').value = id;
            document.getElementById('reg-customer').value = i.customer;
            document.getElementById('reg-region').value = i.region || "";
            document.getElementById('reg-model').value = i.model || "";
            document.getElementById('reg-serial').value = i.serial || "";
            document.getElementById('reg-ip').value = i.ip || "";
            document.getElementById('reg-fw-ver').value = i.fw_version || "";
            document.getElementById('reg-fw-date').value = i.fw_updated_at || "";
            document.getElementById('reg-autofw').value = i.auto_fw || "未設定";
            document.getElementById('reg-pw').value = i.pw || "";
            window.selectedDepts = [...(i.depts || [])];
            updateDeptTags();
            document.getElementById('form-title').innerText = "機器情報の編集";
            document.getElementById('cancel-edit-btn').classList.remove('hidden');
            switchTab('register');
        };

        window.deleteData = async (id) => { if(confirm("削除しますか？")) await deleteDoc(doc(db, "inventory", id)); };

        // 履歴
        window.openLogModal = (id) => {
            window.activeLogDeviceId = id;
            const i = window.inventoryData.find(x => x.id === id);
            document.getElementById('log-modal-title').innerText = `${i.customer} 履歴`;
            document.getElementById('log-modal-subtitle').innerText = `${i.model} (${i.serial})`;
            renderTimeline();
            document.getElementById('log-modal').classList.remove('hidden');
        };
        window.closeLogModal = () => document.getElementById('log-modal').classList.add('hidden');
        window.addLogEntry = async () => {
            const n = document.getElementById('log-input-note').value;
            if(!n) return;
            const log = { date: new Date().toLocaleString('ja-JP'), user: window.currentUser, action: document.getElementById('log-input-action').value, note: n };
            await updateDoc(doc(db, "inventory", window.activeLogDeviceId), { logs: arrayUnion(log) });
            document.getElementById('log-input-note').value = "";
            renderTimeline();
        };
        function renderTimeline() {
            const i = window.inventoryData.find(x => x.id === window.activeLogDeviceId);
            document.getElementById('log-timeline-container').innerHTML = (i.logs || []).slice().reverse().map(l => `
                <div class="relative pl-8">
                    <div class="absolute -left-[9px] top-1.5 w-4 h-4 rounded-full bg-slate-900 border-4 border-white"></div>
                    <div class="bg-slate-50 p-3 rounded-xl border text-xs">
                        <div class="flex justify-between font-bold text-slate-400 mb-1"><span>${l.date}</span><span>${l.user}</span></div>
                        <div class="font-bold text-slate-800">${l.action}</div><p class="mt-1">${l.note}</p>
                    </div>
                </div>`).join('');
        }

        // マスタ管理
        async function saveMasters() {
            await setDoc(masterDoc, { regions: window.masterRegions, depts: window.masterDepts, models: window.masterModels, vuln: window.masterVuln, latestFw: window.masterLatestFw, users: window.masterUsers });
        }
        window.addMaster = (type) => {
            const v = document.getElementById(`new-master-${type}`).value.trim();
            if(!v) return;
            if(type==='region') window.masterRegions.push(v);
            else if(type==='dept') window.masterDepts.push(v);
            else if(type==='model') window.masterModels.push(v);
            else if(type==='vuln') window.masterVuln.push(v);
            saveMasters(); document.getElementById(`new-master-${type}`).value = "";
        };
        window.removeMaster = (type, v) => {
            if(type==='region') window.masterRegions = window.masterRegions.filter(x=>x!==v);
            else if(type==='dept') window.masterDepts = window.masterDepts.filter(x=>x!==v);
            else if(type==='model') window.masterModels = window.masterModels.filter(x=>x!==v);
            else if(type==='vuln') window.masterVuln = window.masterVuln.filter(x=>x!==v);
            saveMasters();
        };
        window.addLatestFwMaster = () => {
            const b = document.getElementById('new-master-latest-branch').value;
            const v = document.getElementById('new-master-latest-ver').value;
            if(b && v) { window.masterLatestFw[b] = v; saveMasters(); }
        };
        window.addMasterUser = () => {
            const u = document.getElementById('new-master-user').value;
            const p = document.getElementById('new-master-pass').value;
            if(u && p) { window.masterUsers.push({user:u, pass:p}); saveMasters(); }
        };

        // UI 操作
        window.switchTab = (t) => {
            ['list', 'register', 'news', 'settings'].forEach(x => {
                document.getElementById(`content-${x}`).classList.add('hidden');
                document.getElementById(`tab-${x}`).classList.remove('tab-active');
            });
            document.getElementById(`content-${t}`).classList.remove('hidden');
            document.getElementById(`tab-${t}`).classList.add('tab-active');
        };
        window.setSearchFilter = (t) => { window.searchFilterType = t; document.getElementById('clear-filter-btn').classList.remove('hidden'); renderTable(); };
        window.clearSearchFilter = () => { window.searchFilterType = null; document.getElementById('clear-filter-btn').classList.add('hidden'); renderTable(); };
        window.cancelEdit = () => { document.getElementById('edit-id').value = ""; document.getElementById('form-title').innerText = "機器情報の登録"; document.getElementById('cancel-edit-btn').classList.add('hidden'); window.selectedDepts = []; updateDeptTags(); };
        window.enterSettings = () => { if(prompt("管理者パスワード") === ADMIN_PW) { document.getElementById('tab-settings').classList.remove('hidden'); switchTab('settings'); } };
        
        // 相乗り部門タグ操作 (修正済み)
        window.addDeptTag = () => {
            const select = document.getElementById('reg-dept-select');
            const v = select.value;
            if(v && !window.selectedDepts.includes(v)) {
                window.selectedDepts.push(v);
                updateDeptTags();
            }
        };
        window.updateDeptTags = () => {
            document.getElementById('selected-depts').innerHTML = window.selectedDepts.map(s => `
                <span class="dept-tag bg-white shadow-sm border">${s} 
                    <i class="fas fa-times cursor-pointer ml-1 text-red-300 hover:text-red-500" onclick="removeDeptTag('${s}')"></i>
                </span>`).join('');
        };
        window.removeDeptTag = (s) => { window.selectedDepts = window.selectedDepts.filter(x=>x!==s); updateDeptTags(); };
        
        window.updateDynamicLists = () => {
            document.getElementById('region-options').innerHTML = window.masterRegions.map(r=>`<option value="${r}">`).join('');
            document.getElementById('model-options').innerHTML = window.masterModels.map(m=>`<option value="${m}">`).join('');
            document.getElementById('reg-dept-select').innerHTML = '<option value="">選択してください...</option>' + window.masterDepts.map(s=>`<option value="${s}">${s}</option>`).join('');
        };
        window.renderMasterLists = () => {
            const d = (arr, t) => arr.map(i => `<div class="flex justify-between bg-white p-1 px-2 border rounded mb-1 text-[10px]"><span>${i}</span><button onclick="removeMaster('${t}','${i}')" class="text-red-300 hover:text-red-500">&times;</button></div>`).join('');
            document.getElementById('settings-region-list').innerHTML = d(window.masterRegions, 'region');
            document.getElementById('settings-model-list').innerHTML = d(window.masterModels, 'model');
            document.getElementById('settings-dept-list').innerHTML = d(window.masterDepts, 'dept');
            document.getElementById('settings-vuln-list').innerHTML = d(window.masterVuln, 'vuln');
        };
        window.renderLatestMaster = () => {
            document.getElementById('settings-latest-fw-list').innerHTML = Object.entries(window.masterLatestFw).map(([b,v])=>`<div class="bg-white p-2 border rounded text-[10px] flex justify-between"><span>${b}.x -> ${v}</span><button onclick="delete window.masterLatestFw['${b}']; saveMasters();" class="text-red-300">&times;</button></div>`).join('');
        };
        window.renderMasterUserList = () => {
            document.getElementById('settings-user-list').innerHTML = window.masterUsers.map(u => `<div class="bg-white p-2 border rounded text-[10px] flex justify-between"><span>${u.user}</span><button onclick="window.masterUsers=window.masterUsers.filter(x=>x.user!=='${u.user}'); saveMasters();" class="text-red-300">&times;</button></div>`).join('');
        };
    </script>
</body>
</html>