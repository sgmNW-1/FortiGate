<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FortiGate 納品管理マスター v14 Cloud & DeepScan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans JP', sans-serif; background-color: #f1f5f9; }
        .tab-active { border-bottom: 3px solid #dc2626; color: #dc2626; background-color: #fff; }
        .system-tag { display: inline-flex; align-items: center; background: #fee2e2; color: #991b1b; padding: 2px 8px; border-radius: 4px; margin: 2px; font-size: 0.75rem; border: 1px solid #fecaca; }
        .news-card { background: white; border: 1px solid #e2e8f0; border-left: 4px solid #dc2626; transition: all 0.2s; }
        .news-card:hover { transform: translateX(5px); box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        .vulnerable-badge { background-color: #fef2f2; border: 1px solid #fee2e2; color: #b91c1c; }
        .auto-vuln-badge { background-color: #fff7ed; border: 1px solid #ffedd5; color: #c2410c; }
        tr:hover .action-btns { opacity: 1; }
        .action-btns { opacity: 0.2; transition: opacity 0.2s; }
        .sync-indicator { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .online { background-color: #10b981; box-shadow: 0 0 8px #10b981; animation: pulse 2s infinite; }
        /* 手動マスタの警告（赤） */
        .alert-row { background-color: #fff1f2 !important; border-left: 4px solid #ef4444; }
        /* 自動検知の警告（オレンジ） */
        .auto-alert-row { background-color: #fff7ed !important; border-left: 4px solid #f97316; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        .scanning-pulse { animation: pulse 1.5s infinite; color: #3b82f6; }
    </style>
</head>
<body class="min-h-screen pb-10">

    <nav class="bg-slate-900 text-white shadow-xl sticky top-0 z-50">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-3 cursor-pointer" onclick="location.reload()">
                <div class="bg-red-600 p-2 rounded-lg"><i class="fas fa-cloud text-white text-xl"></i></div>
                <div>
                    <span class="text-xl font-bold tracking-tighter">FG 納品管理 <span class="text-red-500">Cloud Master v14</span></span>
                    <p class="text-[10px] text-slate-400 leading-none mt-1"><span class="sync-indicator online"></span>クラウド同期中</p>
                </div>
            </div>
            <div class="flex items-center space-x-4">
                <button onclick="enterSettings()" class="text-slate-400 hover:text-white transition-colors" title="管理者設定"><i class="fas fa-cog text-xl"></i></button>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-4 py-8">
        <div class="flex space-x-2 mb-8 bg-gray-200 p-1 rounded-xl w-fit">
            <button onclick="switchTab('list')" id="tab-list" class="px-6 py-2.5 rounded-lg font-bold transition-all tab-active"><i class="fas fa-list mr-2"></i>納品一覧</button>
            <button onclick="switchTab('register')" id="tab-register" class="px-6 py-2.5 rounded-lg font-bold text-gray-600 hover:bg-white transition-all"><i class="fas fa-plus-circle mr-2"></i>新規登録</button>
            <button onclick="switchTab('news')" id="tab-news" class="px-6 py-2.5 rounded-lg font-bold text-gray-600 hover:bg-white transition-all"><i class="fas fa-shield-alt mr-2"></i>脆弱性・最新FW</button>
            <button onclick="switchTab('settings')" id="tab-settings" class="hidden px-6 py-2.5 rounded-lg font-bold text-gray-600 hover:bg-white transition-all"><i class="fas fa-tools mr-2"></i>管理者設定</button>
        </div>

        <div id="content-list" class="block">
            <div class="mb-6 flex flex-wrap gap-4 items-center">
                <div class="relative flex-1 min-w-[300px]">
                    <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-slate-400"><i class="fas fa-search"></i></span>
                    <input type="text" id="search-input" onkeyup="renderTable()" class="w-full border border-slate-300 rounded-xl py-3 pl-10 pr-4 shadow-sm outline-none focus:ring-2 focus:ring-red-500" placeholder="納品先やFWバージョンで検索...">
                </div>
                <div class="text-sm text-slate-500 bg-white px-4 py-3 rounded-xl border shadow-sm">登録件数: <span id="count-total" class="font-bold text-slate-800 text-lg">0</span> 件</div>
            </div>
            <div class="bg-white rounded-2xl shadow-sm border overflow-hidden overflow-x-auto">
                <table class="w-full text-left min-w-[1100px]">
                    <thead class="bg-slate-50 border-b text-[11px] font-bold text-slate-500 uppercase">
                        <tr>
                            <th class="px-6 py-4">納品先 / 地域</th>
                            <th class="px-6 py-4">型番 / シリアル</th>
                            <th class="px-6 py-4">管理IP</th>
                            <th class="px-6 py-4">FW Ver / 更新情報</th>
                            <th class="px-6 py-4">自動FW</th>
                            <th class="px-6 py-4">ログインPW</th>
                            <th class="px-6 py-4">関連システム</th>
                            <th class="px-6 py-4 text-center">操作</th>
                        </tr>
                    </thead>
                    <tbody id="inventory-tbody" class="divide-y divide-slate-100 text-sm"></tbody>
                </table>
            </div>
        </div>

        <div id="content-register" class="hidden">
            <div class="max-w-4xl mx-auto bg-white p-8 rounded-3xl shadow-xl border">
                <h2 id="form-title" class="text-2xl font-bold mb-8 border-l-4 border-red-600 pl-4">機器情報の登録</h2>
                <input type="hidden" id="edit-id" value="">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div><label class="text-sm font-bold text-slate-700">納品先名 <span class="text-red-500">*</span></label><input type="text" id="reg-customer" class="w-full border rounded-xl p-3 focus:ring-2 focus:ring-red-500 outline-none mt-1" placeholder="例: 株式会社サンプル"></div>
                    
                    <div>
                        <label class="text-sm font-bold text-slate-700">地域</label>
                        <input list="region-options" id="reg-region" class="w-full border rounded-xl p-3 mt-1 outline-none focus:ring-2 focus:ring-red-500" placeholder="選択するか入力">
                        <datalist id="region-options"></datalist>
                    </div>
                    <div>
                        <label class="text-sm font-bold text-slate-700">型番</label>
                        <input list="model-options" id="reg-model" class="w-full border rounded-xl p-3 mt-1 outline-none focus:ring-2 focus:ring-red-500" placeholder="選択するか入力">
                        <datalist id="model-options"></datalist>
                    </div>
                    
                    <div><label class="text-sm font-bold text-slate-700">シリアルナンバー</label><input type="text" id="reg-serial" class="w-full border rounded-xl p-3 mt-1 outline-none focus:ring-2 focus:ring-red-500" placeholder="例: FGT60FTK20001234"></div>
                    <div><label class="text-sm font-bold text-slate-700">管理IPアドレス</label><input type="text" id="reg-ip" class="w-full border rounded-xl p-3 mt-1 outline-none focus:ring-2 focus:ring-red-500" placeholder="例: 192.168.1.99"></div>
                    <div><label class="text-sm font-bold text-slate-700">FWバージョン</label><input type="text" id="reg-fw-ver" class="w-full border rounded-xl p-3 mt-1 outline-none focus:ring-2 focus:ring-red-500" placeholder="例: 7.2.4"></div>
                    <div><label class="text-sm font-bold text-slate-700">FW最終更新日</label><input type="date" id="reg-fw-date" class="w-full border rounded-xl p-3 mt-1 outline-none focus:ring-2 focus:ring-red-500"></div>
                    
                    <div>
                        <label class="text-sm font-bold text-slate-700">自動ファームウェア設定</label>
                        <select id="reg-autofw" class="w-full border rounded-xl p-3 mt-1 outline-none focus:ring-2 focus:ring-red-500 bg-white">
                            <option value="未設定">未設定 / 不明</option>
                            <option value="OFF">OFF (手動更新)</option>
                            <option value="ON">ON (自動更新)</option>
                        </select>
                    </div>

                    <div><label class="text-sm font-bold text-slate-700">機器ログインPW</label><input type="text" id="reg-pw" class="w-full border rounded-xl p-3 mt-1 outline-none focus:ring-2 focus:ring-red-500" placeholder="管理者パスワード"></div>
                    
                    <div class="md:col-span-2">
                        <label class="text-sm font-bold text-slate-700">関連システムタグ</label>
                        <div class="flex gap-2 mt-2">
                            <select id="reg-sys-select" class="flex-1 border rounded-xl p-3 outline-none focus:ring-2 focus:ring-red-500 bg-white"></select>
                            <button onclick="addSystemTag()" class="bg-slate-800 text-white px-8 rounded-xl font-bold hover:bg-slate-700 transition-colors">タグ追加</button>
                        </div>
                        <div id="selected-systems" class="flex flex-wrap p-4 bg-slate-50 rounded-2xl border border-dashed mt-3 min-h-[70px] items-center text-sm text-slate-400">
                            追加されたシステムタグがここに表示されます
                        </div>
                    </div>
                </div>
                <div class="mt-10 flex justify-end space-x-4">
                    <button id="cancel-edit-btn" onclick="cancelEdit()" class="hidden bg-slate-100 px-8 py-3 rounded-xl font-bold hover:bg-slate-200 transition-colors">キャンセル</button>
                    <button onclick="saveData()" class="bg-red-600 text-white px-12 py-3 rounded-xl font-bold shadow-lg hover:bg-red-700 transition-colors flex items-center"><i class="fas fa-cloud-upload-alt mr-2"></i>クラウドに保存</button>
                </div>
            </div>
        </div>

        <div id="content-news" class="hidden">
            <div id="deep-scan-status" class="mb-4 bg-blue-50 text-blue-700 p-3 rounded-xl border border-blue-200 text-sm font-bold hidden flex items-center">
                <i class="fas fa-satellite-dish scanning-pulse mr-2 text-lg"></i>
                <span>ディープスキャン実行中：リンク先の詳細ページを解析し、最新FWと脆弱性バージョンを自動抽出しています...</span>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2">
                    <h3 class="font-bold text-lg mb-4 text-slate-700 flex items-center"><i class="fas fa-rss text-orange-500 mr-2"></i>FortiGuard 最新ニュース（自動取得）</h3>
                    <div id="news-container" class="space-y-4"></div>
                </div>
                
                <div class="space-y-6">
                    <div class="bg-white p-6 rounded-2xl border-2 border-blue-200 shadow-md">
                        <h3 class="text-blue-700 font-bold mb-3 border-b border-blue-200 pb-2 flex items-center"><i class="fas fa-level-up-alt mr-2 text-xl"></i>各OS系統の最新ファーム</h3>
                        <p class="text-[10px] text-slate-500 mb-3 leading-relaxed">
                            ※リンク先ページから**完全自動**で最新版を割り出しています。一覧表の機器がこれより古い場合、更新マーク（⬆️）が出ます。
                        </p>
                        <div class="grid grid-cols-1 gap-2" id="latest-fw-display">
                            <span class="text-xs text-slate-400">取得中...</span>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-2xl border-2 border-orange-200 shadow-md">
                        <h3 class="text-orange-700 font-bold mb-3 border-b border-orange-200 pb-2 flex items-center"><i class="fas fa-robot mr-2 text-xl"></i>AI自動抽出バージョン</h3>
                        <p class="text-[10px] text-slate-500 mb-3 leading-relaxed">
                            ※詳細ページをディープスキャンし、**自動で抜き出した脆弱性FW**です。一覧表では<span class="text-orange-600 font-bold">オレンジ色</span>で警告されます。
                        </p>
                        <div class="flex flex-wrap gap-2" id="auto-vuln-list-display">
                            <span class="text-xs text-slate-400">取得中...</span>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-2xl border-2 border-red-200 shadow-md">
                        <h3 class="text-red-700 font-bold mb-3 border-b border-red-200 pb-2 flex items-center"><i class="fas fa-biohazard mr-2 text-xl"></i>確定要注意バージョン(手動)</h3>
                        <p class="text-[10px] text-slate-500 mb-3 leading-relaxed">
                            ※設定タブで手動登録した確実な危険バージョンです。自動検知漏れを防ぐための予備機能です。
                        </p>
                        <div class="space-y-2" id="vuln-list-display">
                            </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="content-settings" class="hidden">
            <div class="max-w-5xl mx-auto bg-white p-8 rounded-3xl border shadow-xl">
                <h2 class="text-2xl font-bold mb-8 border-l-4 border-slate-800 pl-4">システム設定マスター</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8 mb-8">
                    <div class="bg-slate-50 p-4 rounded-xl border">
                        <h3 class="font-bold mb-4 flex items-center text-slate-700 text-sm"><i class="fas fa-map-marker-alt mr-2 text-green-600"></i>地域マスタ</h3>
                        <div class="flex gap-2 mb-4"><input type="text" id="new-master-region" class="flex-1 border rounded-lg p-2 text-xs outline-none" placeholder="追加する地域"><button onclick="addMaster('region')" class="bg-slate-800 text-white px-3 py-2 rounded-lg text-xs font-bold hover:bg-slate-700">追加</button></div>
                        <div id="settings-region-list" class="space-y-1 max-h-60 overflow-y-auto"></div>
                    </div>
                    <div class="bg-slate-50 p-4 rounded-xl border">
                        <h3 class="font-bold mb-4 flex items-center text-slate-700 text-sm"><i class="fas fa-microchip mr-2 text-blue-600"></i>型番マスタ</h3>
                        <div class="flex gap-2 mb-4"><input type="text" id="new-master-model" class="flex-1 border rounded-lg p-2 text-xs outline-none" placeholder="追加する型番"><button onclick="addMaster('model')" class="bg-slate-800 text-white px-3 py-2 rounded-lg text-xs font-bold hover:bg-slate-700">追加</button></div>
                        <div id="settings-model-list" class="space-y-1 max-h-60 overflow-y-auto"></div>
                    </div>
                    <div class="bg-slate-50 p-4 rounded-xl border">
                        <h3 class="font-bold mb-4 flex items-center text-slate-700 text-sm"><i class="fas fa-tags mr-2 text-purple-600"></i>システム名マスタ</h3>
                        <div class="flex gap-2 mb-4"><input type="text" id="new-master-sys" class="flex-1 border rounded-lg p-2 text-xs outline-none" placeholder="追加するシステム"><button onclick="addMaster('system')" class="bg-slate-800 text-white px-3 py-2 rounded-lg text-xs font-bold hover:bg-slate-700">追加</button></div>
                        <div id="settings-sys-list" class="space-y-1 max-h-60 overflow-y-auto"></div>
                    </div>
                    <div class="bg-red-50 p-4 rounded-xl border border-red-200">
                        <h3 class="font-bold mb-4 flex items-center text-red-700 text-sm"><i class="fas fa-exclamation-triangle mr-2"></i>要注意FWマスタ(手動)</h3>
                        <div class="flex gap-2 mb-4"><input type="text" id="new-master-vuln" class="flex-1 border rounded-lg p-2 text-xs outline-none focus:ring-red-500" placeholder="例: 7.2.3"><button onclick="addMaster('vuln')" class="bg-red-600 text-white px-3 py-2 rounded-lg text-xs font-bold hover:bg-red-700">追加</button></div>
                        <div id="settings-vuln-list" class="space-y-1 max-h-60 overflow-y-auto"></div>
                    </div>
                </div>

                <div class="bg-blue-50 p-4 rounded-xl border border-blue-200 w-full">
                    <h3 class="font-bold mb-4 flex items-center text-blue-700 text-sm"><i class="fas fa-arrow-alt-circle-up mr-2"></i>最新FWマスタ（手動上書き用）</h3>
                    <p class="text-[10px] text-slate-500 mb-4">※自動検知を上書きしたい場合のみ登録してください（例: 7.2 と 7.2.14）。</p>
                    <div class="flex gap-2 mb-4 max-w-lg">
                        <input type="text" id="new-master-latest-branch" class="w-1/3 border rounded-lg p-2 text-xs outline-none focus:ring-blue-500 bg-white" placeholder="系統 (例: 7.2)">
                        <input type="text" id="new-master-latest-ver" class="flex-1 border rounded-lg p-2 text-xs outline-none focus:ring-blue-500 bg-white" placeholder="最新版 (例: 7.2.14)">
                        <button onclick="addLatestFwMaster()" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-xs font-bold hover:bg-blue-700">登録</button>
                    </div>
                    <div id="settings-latest-fw-list" class="grid grid-cols-1 md:grid-cols-3 gap-3 max-h-60 overflow-y-auto"></div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, addDoc, updateDoc, deleteDoc, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // Firebase 接続キー
        const firebaseConfig = {
            apiKey: "AIzaSyA1natPUopWd-2SlfOAzJULYiSlJudm2Rs",
            authDomain: "fg-delivery-master.firebaseapp.com",
            projectId: "fg-delivery-master",
            storageBucket: "fg-delivery-master.firebasestorage.app",
            messagingSenderId: "752211748822",
            appId: "1:752211748822:web:754e385096f54e7ac2e677",
            measurementId: "G-Y3ZLVNTHFD"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const inventoryCol = collection(db, "inventory");
        const masterDoc = doc(db, "config", "masters");

        // 初期データ
        window.inventoryData = [];
        window.masterRegions = ["北海道", "東北", "関東", "中部", "近畿", "中国", "四国", "九州", "沖縄"];
        window.masterSystems = ["情報システム部", "営業部", "経理・総務", "基幹システム"];
        window.masterModels = ["FG-40F", "FG-60F", "FG-80F", "FG-100F"];
        window.masterVuln = ["7.2.0", "7.0.5"]; 
        window.masterLatestFw = {}; 
        
        window.autoDetectedVuln = []; 
        window.autoLatestFw = {}; 

        window.selectedSystems = [];
        const ADMIN_PW = "komayuu28";
        const VIEW_PW = "sigma-sol2012";

        // クラウドからのリアルタイム取得
        onSnapshot(inventoryCol, (snapshot) => {
            window.inventoryData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderTable();
        });

        onSnapshot(masterDoc, (docSnap) => {
            if (docSnap.exists()) {
                const data = docSnap.data();
                window.masterRegions = data.regions || window.masterRegions;
                window.masterSystems = data.systems || window.masterSystems;
                window.masterModels = data.models || window.masterModels;
                window.masterVuln = data.vuln || window.masterVuln;
                window.masterLatestFw = data.latestFw || window.masterLatestFw;
                updateDynamicLists();
                renderVulnDisplay();
                renderLatestFwMaster();
                renderLatestFwDisplay();
                renderTable();
            } else {
                setDoc(masterDoc, { regions: window.masterRegions, systems: window.masterSystems, models: window.masterModels, vuln: window.masterVuln, latestFw: window.masterLatestFw });
            }
        });

        // 納品データ保存処理
        window.saveData = async () => {
            const id = document.getElementById('edit-id').value;
            const newItem = {
                customer: document.getElementById('reg-customer').value,
                region: document.getElementById('reg-region').value,
                model: document.getElementById('reg-model').value,
                serial: document.getElementById('reg-serial').value,
                ip: document.getElementById('reg-ip').value,
                fw_version: document.getElementById('reg-fw-ver').value,
                fw_updated_at: document.getElementById('reg-fw-date').value,
                auto_fw: document.getElementById('reg-autofw').value,
                pw: document.getElementById('reg-pw').value,
                systems: [...window.selectedSystems],
                updatedAt: new Date()
            };

            if(!newItem.customer) return alert("納品先名は必ず入力してください");

            try {
                if(id) await updateDoc(doc(db, "inventory", id), newItem);
                else await addDoc(inventoryCol, newItem);
                alert("クラウドへ保存が完了しました！");
                cancelEdit(); 
                switchTab('list');
            } catch (e) { alert("保存に失敗しました: " + e); }
        };

        window.deleteData = async (id) => {
            if(confirm("このデータを完全に削除してもよろしいですか？")) {
                await deleteDoc(doc(db, "inventory", id));
            }
        };

        // 一覧表の描画
        window.renderTable = () => {
            const term = document.getElementById('search-input').value.toLowerCase();
            const tbody = document.getElementById('inventory-tbody');
            const filtered = window.inventoryData.filter(i => 
                (i.customer || "").toLowerCase().includes(term) || 
                (i.fw_version || "").toLowerCase().includes(term) || 
                (i.model || "").toLowerCase().includes(term) ||
                (i.serial || "").toLowerCase().includes(term)
            );
            
            document.getElementById('count-total').innerText = filtered.length;
            
            tbody.innerHTML = filtered.map(item => {
                const isMasterVuln = window.masterVuln.includes(item.fw_version);
                const isAutoVuln = window.autoDetectedVuln.includes(item.fw_version);
                
                let rowClass = "hover:bg-slate-50 transition-colors";
                let fwClass = "text-green-700 font-bold";
                let alertIcon = "";
                
                if (isMasterVuln) {
                    rowClass = "alert-row";
                    fwClass = "text-red-600 font-bold bg-red-100 px-2 py-1 rounded border border-red-200";
                    alertIcon = '<i class="fas fa-exclamation-triangle text-red-500 mr-1" title="手動確定済みの危険バージョン"></i>';
                } else if (isAutoVuln) {
                    rowClass = "auto-alert-row";
                    fwClass = "text-orange-600 font-bold bg-orange-100 px-2 py-1 rounded border border-orange-200";
                    alertIcon = '<i class="fas fa-robot text-orange-500 mr-1" title="ディープスキャンで検知された危険バージョン"></i>';
                }
                
                let autoFwBadge = '<span class="text-slate-400 text-xs">未設定</span>';
                if(item.auto_fw === "ON") autoFwBadge = '<span class="bg-blue-100 text-blue-700 border border-blue-200 px-2 py-1 rounded text-[10px] font-bold">ON (自動)</span>';
                if(item.auto_fw === "OFF") autoFwBadge = '<span class="bg-slate-100 text-slate-600 border border-slate-200 px-2 py-1 rounded text-[10px] font-bold">OFF (手動)</span>';

                let fwUpdateBadge = '';
                const fwMatch = (item.fw_version || "").match(/^(\d+\.\d+)\.(\d+)$/);
                if(fwMatch) {
                    const branch = fwMatch[1];
                    const patch = parseInt(fwMatch[2]);
                    const latestStr = (window.masterLatestFw && window.masterLatestFw[branch]) ? window.masterLatestFw[branch] : window.autoLatestFw[branch];
                    
                    if(latestStr) {
                        const latestMatch = latestStr.match(/^(\d+\.\d+)\.(\d+)$/);
                        if(latestMatch && parseInt(latestMatch[2]) > patch) {
                            fwUpdateBadge = `<div class="text-[10px] text-blue-600 font-bold mt-1.5 bg-blue-50 px-2 py-0.5 rounded inline-block border border-blue-200 shadow-sm" title="最新バージョン ${latestStr} がリリースされています"><i class="fas fa-arrow-circle-up mr-1"></i>最新 ${latestStr} あり</div>`;
                        }
                    }
                }

                return `
                <tr class="${rowClass} group">
                    <td class="px-6 py-5"><div class="font-bold text-slate-800">${item.customer}</div><div class="text-[10px] text-slate-500"><i class="fas fa-map-marker-alt mr-1"></i>${item.region || '未登録'}</div></td>
                    <td class="px-6 py-5"><div class="font-mono text-xs font-bold text-slate-700 bg-slate-100 px-2 py-0.5 rounded inline-block border">${item.model || '-'}</div><div class="text-[10px] text-slate-500 mt-1 font-mono">${item.serial || '-'}</div></td>
                    <td class="px-6 py-5 text-xs font-mono">${item.ip || '-'}</td>
                    <td class="px-6 py-5">
                        <div class="text-xs ${fwClass} inline-block">${alertIcon}${item.fw_version || '-'}</div><br>
                        ${fwUpdateBadge}
                        <div class="text-[9px] text-slate-400 mt-1">${item.fw_updated_at || ''}</div>
                    </td>
                    <td class="px-6 py-5">${autoFwBadge}</td>
                    <td class="px-6 py-5"><button onclick="showPw('${item.pw || ''}')" class="text-[10px] bg-white hover:bg-slate-50 py-1.5 px-3 rounded-md border shadow-sm transition-all"><i class="fas fa-key mr-1 text-slate-400"></i>表示</button></td>
                    <td class="px-6 py-5"><div class="flex flex-wrap">${(item.systems || []).map(s => `<span class="system-tag">${s}</span>`).join('')}</div></td>
                    <td class="px-6 py-5 text-center">
                        <div class="action-btns flex justify-center space-x-2">
                            <button onclick="editData('${item.id}')" class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition-colors" title="編集"><i class="fas fa-edit"></i></button>
                            <button onclick="deleteData('${item.id}')" class="p-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors" title="削除"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    </td>
                </tr>`;
            }).join('');
        };

        window.addMaster = async (type) => {
            const inputId = `new-master-${type}`;
            const val = document.getElementById(inputId).value.trim();
            if(!val) return;
            
            if(type === 'region') window.masterRegions.push(val);
            else if(type === 'system') window.masterSystems.push(val);
            else if(type === 'model') window.masterModels.push(val);
            else if(type === 'vuln') window.masterVuln.push(val);
            
            await setDoc(masterDoc, { regions: window.masterRegions, systems: window.masterSystems, models: window.masterModels, vuln: window.masterVuln, latestFw: window.masterLatestFw });
            document.getElementById(inputId).value = "";
            renderMasterLists();
        };

        window.removeMaster = async (type, val) => {
            if(!confirm(`「${val}」をマスタから削除しますか？`)) return;
            
            if(type === 'region') window.masterRegions = window.masterRegions.filter(x => x !== val);
            else if(type === 'system') window.masterSystems = window.masterSystems.filter(x => x !== val);
            else if(type === 'model') window.masterModels = window.masterModels.filter(x => x !== val);
            else if(type === 'vuln') window.masterVuln = window.masterVuln.filter(x => x !== val);
            
            await setDoc(masterDoc, { regions: window.masterRegions, systems: window.masterSystems, models: window.masterModels, vuln: window.masterVuln, latestFw: window.masterLatestFw });
            renderMasterLists();
        };

        window.addLatestFwMaster = async () => {
            const branch = document.getElementById('new-master-latest-branch').value.trim();
            const ver = document.getElementById('new-master-latest-ver').value.trim();
            if(!branch || !ver) return;
            if(!window.masterLatestFw) window.masterLatestFw = {};
            window.masterLatestFw[branch] = ver;
            await setDoc(masterDoc, { regions: window.masterRegions, systems: window.masterSystems, models: window.masterModels, vuln: window.masterVuln, latestFw: window.masterLatestFw });
            document.getElementById('new-master-latest-branch').value = "";
            document.getElementById('new-master-latest-ver').value = "";
            renderLatestFwMaster(); renderLatestFwDisplay(); renderTable();
        };

        window.removeLatestFwMaster = async (branch) => {
            if(!confirm(`系統「${branch}」の最新FW設定を削除しますか？`)) return;
            delete window.masterLatestFw[branch];
            await setDoc(masterDoc, { regions: window.masterRegions, systems: window.masterSystems, models: window.masterModels, vuln: window.masterVuln, latestFw: window.masterLatestFw });
            renderLatestFwMaster(); renderLatestFwDisplay(); renderTable();
        };

        window.switchTab = (tab) => {
            ['list', 'register', 'news', 'settings'].forEach(t => {
                document.getElementById(`content-${t}`).classList.add('hidden');
                document.getElementById(`tab-${t}`).classList.remove('tab-active');
            });
            document.getElementById(`content-${tab}`).classList.remove('hidden');
            document.getElementById(`tab-${tab}`).classList.add('tab-active');
            if(tab === 'news') fetchNews();
            if(tab === 'settings') { renderMasterLists(); renderLatestFwMaster(); }
        };

        window.editData = (id) => {
            const item = window.inventoryData.find(i => i.id === id);
            document.getElementById('edit-id').value = id;
            document.getElementById('reg-customer').value = item.customer || "";
            document.getElementById('reg-region').value = item.region || "";
            document.getElementById('reg-model').value = item.model || "";
            document.getElementById('reg-serial').value = item.serial || "";
            document.getElementById('reg-ip').value = item.ip || "";
            document.getElementById('reg-fw-ver').value = item.fw_version || "";
            document.getElementById('reg-fw-date').value = item.fw_updated_at || "";
            document.getElementById('reg-autofw').value = item.auto_fw || "未設定";
            document.getElementById('reg-pw').value = item.pw || "";
            window.selectedSystems = [...(item.systems || [])];
            updateSystemTags();
            document.getElementById('form-title').innerHTML = "機器情報の編集";
            document.getElementById('cancel-edit-btn').classList.remove('hidden');
            switchTab('register');
        };

        window.cancelEdit = () => {
            document.getElementById('edit-id').value = "";
            ['reg-customer','reg-region','reg-model','reg-serial','reg-ip','reg-fw-ver','reg-fw-date','reg-pw'].forEach(id => document.getElementById(id).value = "");
            document.getElementById('reg-autofw').value = "未設定";
            window.selectedSystems = []; updateSystemTags();
            document.getElementById('form-title').innerHTML = "機器情報の登録";
            document.getElementById('cancel-edit-btn').classList.add('hidden');
        };

        window.showPw = (pw) => { 
            if(!pw) { alert("パスワードは登録されていません"); return; }
            if(prompt("閲覧用パスワードを入力してください") === VIEW_PW) alert("パスワード: " + pw); 
            else alert("パスワードが違います"); 
        };

        window.addSystemTag = () => {
            const v = document.getElementById('reg-sys-select').value;
            if(v && !window.selectedSystems.includes(v)) { window.selectedSystems.push(v); updateSystemTags(); }
        };
        window.updateSystemTags = () => {
            const container = document.getElementById('selected-systems');
            if(window.selectedSystems.length === 0) container.innerHTML = "追加されたシステムタグがここに表示されます";
            else container.innerHTML = window.selectedSystems.map(s => `<span class="system-tag bg-slate-100 border-slate-300 text-slate-700 py-1 px-3 text-sm">${s} <i class="fas fa-times-circle ml-2 cursor-pointer text-slate-400 hover:text-red-500" onclick="removeTag('${s}')"></i></span>`).join('');
        };
        window.removeTag = (s) => { window.selectedSystems = window.selectedSystems.filter(x => x !== s); updateSystemTags(); };

        window.updateDynamicLists = () => {
            document.getElementById('region-options').innerHTML = window.masterRegions.map(r => `<option value="${r}">`).join('');
            document.getElementById('model-options').innerHTML = window.masterModels.map(m => `<option value="${m}">`).join('');
            document.getElementById('reg-sys-select').innerHTML = '<option value="">システムを選択...</option>' + window.masterSystems.map(s => `<option value="${s}">${s}</option>`).join('');
        };

        window.renderMasterLists = () => {
            const createList = (arr, type) => arr.map(item => `<div class="flex justify-between items-center bg-white p-2 border rounded-lg text-sm mb-1 hover:bg-slate-50"><span>${item}</span><button onclick="removeMaster('${type}', '${item}')" class="text-slate-300 hover:text-red-500 transition-colors"><i class="fas fa-trash-alt"></i></button></div>`).join('');
            document.getElementById('settings-region-list').innerHTML = createList(window.masterRegions, 'region');
            document.getElementById('settings-sys-list').innerHTML = createList(window.masterSystems, 'system');
            document.getElementById('settings-model-list').innerHTML = createList(window.masterModels, 'model');
            document.getElementById('settings-vuln-list').innerHTML = createList(window.masterVuln, 'vuln');
        };

        window.renderLatestFwMaster = () => {
            const container = document.getElementById('settings-latest-fw-list');
            const entries = Object.entries(window.masterLatestFw || {});
            container.innerHTML = entries.map(([branch, ver]) => 
                `<div class="flex justify-between items-center bg-white p-2 border rounded-lg text-sm hover:bg-slate-50 shadow-sm"><span class="font-bold text-slate-700">${branch}.x <i class="fas fa-arrow-right text-slate-400 text-[10px] mx-1"></i> <span class="text-blue-600">${ver}</span></span><button onclick="removeLatestFwMaster('${branch}')" class="text-slate-300 hover:text-red-500 transition-colors"><i class="fas fa-trash-alt"></i></button></div>`
            ).join('');
        };

        window.renderVulnDisplay = () => {
            const container = document.getElementById('vuln-list-display');
            if(window.masterVuln.length === 0) container.innerHTML = '<div class="text-xs text-slate-500">現在手動登録されている要注意バージョンはありません。</div>';
            else container.innerHTML = window.masterVuln.map(v => `<div class="p-3 vulnerable-badge rounded-lg flex items-center shadow-sm"><i class="fas fa-skull-crossbones mr-3 opacity-70 text-lg"></i><div><div class="font-extrabold text-sm tracking-widest">v ${v}</div></div></div>`).join('');
        };

        window.renderLatestFwDisplay = () => {
            const container = document.getElementById('latest-fw-display');
            const combined = { ...window.autoLatestFw };
            Object.keys(window.masterLatestFw || {}).forEach(k => { combined[k] = window.masterLatestFw[k]; });
            const branches = Object.keys(combined).sort((a, b) => b.localeCompare(a));
            
            if(branches.length === 0) { container.innerHTML = '<span class="text-xs text-slate-400">データがありません</span>'; return; }

            container.innerHTML = branches.map(branch => {
                const ver = combined[branch];
                const isMaster = !!(window.masterLatestFw && window.masterLatestFw[branch]);
                const badge = isMaster ? '<span class="text-[9px] bg-blue-600 text-white px-1.5 py-0.5 rounded ml-2 shadow-sm">手動優先</span>' : '<span class="text-[9px] bg-green-500 text-white px-1.5 py-0.5 rounded ml-2 shadow-sm">自動抽出完了</span>';
                return `<div class="bg-slate-50 border rounded-lg p-3 flex justify-between items-center shadow-sm"><span class="font-bold text-slate-600 text-sm border-b-2 border-slate-300">${branch}.x</span><div class="flex items-center"><span class="font-mono text-blue-700 font-black text-lg">${ver}</span>${badge}</div></div>`;
            }).join('');
        };

        window.enterSettings = () => { 
            if(prompt("管理者パスワード") === ADMIN_PW) { 
                document.getElementById('tab-settings').classList.remove('hidden'); 
                switchTab('settings'); 
            } 
        };

        // 【限界突破】CORS回避プロキシを用いたディープスキャン自動化ロジック
        async function fetchNews() {
            const container = document.getElementById('news-container');
            const statusIndicator = document.getElementById('deep-scan-status');
            
            if(container.innerHTML !== "" && !container.innerHTML.includes("取得中")) return; 
            
            container.innerHTML = '<div class="text-center py-10 text-slate-400"><i class="fas fa-spinner fa-spin text-3xl mb-3"></i><br>RSSを取得中...</div>';
            statusIndicator.classList.remove('hidden');

            try {
                // 1. RSSの取得
                const rss = "https://api.rss2json.com/v1/api.json?rss_url=" + encodeURIComponent("https://www.fortiguard.com/rss/ir.xml");
                const res = await fetch(rss);
                const data = await res.json();
                
                let tempVulnSet = new Set();
                let tempLatestMap = {}; // branch -> max patch

                // 2. 記事カードの作成
                container.innerHTML = data.items.slice(0, 8).map(i => {
                    const descText = i.description.replace(/<[^>]*>?/gm, '');
                    return `
                    <div class="news-card p-5 rounded-xl border">
                        <div class="flex items-center mb-2">
                            <span class="text-[10px] bg-orange-100 text-orange-700 px-2 py-0.5 rounded font-bold">PSIRT</span>
                            <span class="text-[10px] text-slate-400 ml-2">${i.pubDate ? i.pubDate.split(' ')[0] : ''}</span>
                        </div>
                        <h4 class="font-bold text-sm mb-2 text-slate-800">${i.title}</h4>
                        <p class="text-[11px] text-slate-500 mb-3 line-clamp-2">${descText}</p>
                        <a href="${i.link}" target="_blank" class="text-[10px] text-blue-600 font-bold hover:underline bg-blue-50 px-3 py-1.5 rounded-lg inline-block">公式詳細ページ（英語） <i class="fas fa-external-link-alt ml-1"></i></a>
                    </div>`;
                }).join('');

                // 3. 【裏技】上位記事のリンク先にプロキシ経由でアクセスして本文を直接スキャン！
                const versionRegex = /\b([567]\.\d+\.\d+)\b/g;
                
                for(let i = 0; i < Math.min(3, data.items.length); i++) {
                    const targetLink = data.items[i].link;
                    if(targetLink.includes("fortiguard.com/psirt")) {
                        try {
                            // allorigins プロキシを利用してCORSを回避し、HTMLの中身を直接取得
                            const proxyUrl = "https://api.allorigins.win/get?url=" + encodeURIComponent(targetLink);
                            const proxyRes = await fetch(proxyUrl);
                            const proxyData = await proxyRes.json();
                            const htmlContent = proxyData.contents;

                            if(htmlContent) {
                                // ページ内のすべてのバージョン表記を抽出
                                const matches = htmlContent.match(versionRegex);
                                if(matches) {
                                    // 系統ごとに分類して最大のものを「最新（解決策）」とし、それ以外を「脆弱性」とする
                                    let branchMap = {};
                                    matches.forEach(m => {
                                        const parts = m.split('.');
                                        if(parts.length >= 3) {
                                            const branch = `${parts[0]}.${parts[1]}`;
                                            const patch = parseInt(parts[2]);
                                            if(!branchMap[branch]) branchMap[branch] = [];
                                            branchMap[branch].push(patch);
                                        }
                                    });

                                    // 分類ロジック実行
                                    Object.keys(branchMap).forEach(branch => {
                                        const maxPatch = Math.max(...branchMap[branch]);
                                        // 最新版を登録
                                        if(!tempLatestMap[branch] || tempLatestMap[branch] < maxPatch) {
                                            tempLatestMap[branch] = maxPatch;
                                        }
                                        // 最大以外の数字はすべて脆弱性として登録
                                        branchMap[branch].forEach(p => {
                                            if(p !== maxPatch) tempVulnSet.add(`${branch}.${p}`);
                                        });
                                    });
                                }
                            }
                        } catch(err) {
                            console.warn("ディープスキャンに一部失敗しました", err);
                        }
                    }
                }

                // 4. スキャン結果をグローバル変数に反映
                window.autoDetectedVuln = Array.from(tempVulnSet);
                window.autoLatestFw = {};
                Object.keys(tempLatestMap).forEach(branch => {
                    window.autoLatestFw[branch] = `${branch}.${tempLatestMap[branch]}`;
                });

                // UIの更新
                const autoContainer = document.getElementById('auto-vuln-list-display');
                if(window.autoDetectedVuln.length > 0) {
                    autoContainer.innerHTML = window.autoDetectedVuln.map(v => `<span class="auto-vuln-badge px-3 py-1 rounded text-xs font-bold tracking-widest shadow-sm">v ${v}</span>`).join('');
                } else {
                    autoContainer.innerHTML = '<span class="text-xs text-slate-400">現在検知された脆弱性バージョンはありません</span>';
                }

                renderLatestFwDisplay();
                renderTable();
                
                statusIndicator.classList.add('hidden'); // スキャン完了メッセージを隠す

            } catch (e) { 
                container.innerHTML = '<div class="text-red-500 bg-red-50 p-4 rounded-xl border border-red-200">ニュース・スキャンの実行に失敗しました。</div>'; 
                document.getElementById('auto-vuln-list-display').innerHTML = '<span class="text-xs text-red-400">解析エラー</span>';
                statusIndicator.classList.add('hidden');
            }
        }

        updateDynamicLists();
        renderVulnDisplay();
        fetchNews();
    </script>
</body>
</html>